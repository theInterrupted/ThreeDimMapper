!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],t):t(e.maptalks=e.maptalks||{},e.maptalks,e.THREE)}(this,function(e,ue,le){"use strict";var t,n,r="object"==typeof e&&"undefined"!=typeof module;ue=ue;function i(e,t){e.prototype=Object.create(t.prototype),(e.prototype.constructor=e).__proto__=t}r&&(ue=ue||require("maptalks")),n=function(e){var w=n,t=n;function n(e,t,n){n=n||2;var r,i,o,a,s,h,u,l=t&&t.length,c=l?t[0]*n:e.length,f=g(e,0,c,n,!0),v=[];if(!f||f.next===f.prev)return v;if(l&&(f=function(e,t,n,r){var i,o,a,s,h,u=[];for(i=0,o=t.length;i<o;i++)a=t[i]*r,s=i<o-1?t[i+1]*r:e.length,(h=g(e,a,s,r,!1))===h.next&&(h.steiner=!0),u.push(_(h));for(u.sort(y),i=0;i<u.length;i++)m(u[i],n),n=p(n,n.next);return n}(e,t,f,n)),e.length>80*n){r=o=e[0],i=a=e[1];for(var d=n;d<c;d+=n)(s=e[d])<r&&(r=s),(h=e[d+1])<i&&(i=h),o<s&&(o=s),a<h&&(a=h);u=0!==(u=Math.max(o-r,a-i))?1/u:0}return x(f,v,n,r,i,u),v}function g(e,t,n,r,i){var o,a;if(i===0<S(e,t,n,r))for(o=t;o<n;o+=r)a=s(o,e[o],e[o+1],a);else for(o=n-r;t<=o;o-=r)a=s(o,e[o],e[o+1],a);return a&&d(a,a.next)&&(A(a),a=a.next),a}function p(e,t){if(!e)return e;t=t||e;var n,r=e;do{if(n=!1,r.steiner||!d(r,r.next)&&0!==O(r.prev,r,r.next))r=r.next;else{if(A(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function x(e,t,n,r,i,o,a){if(e){!a&&o&&function(e,t,n,r){var i=e;for(;null===i.z&&(i.z=b(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==e;);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,o,a,s,h,u=1;do{for(n=e,o=e=null,a=0;n;){for(a++,r=n,t=s=0;t<u&&(s++,r=r.nextZ);t++);for(h=u;0<s||0<h&&r;)0!==s&&(0===h||!r||n.z<=r.z)?(n=(i=n).nextZ,s--):(r=(i=r).nextZ,h--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;n=r}o.nextZ=null,u*=2}while(1<a)}(i)}(e,r,i,o);for(var s,h,u=e;e.prev!==e.next;)if(s=e.prev,h=e.next,o?c(e,r,i,o):l(e))t.push(s.i/n),t.push(e.i/n),t.push(h.i/n),A(e),e=h.next,u=h.next;else if((e=h)===u){a?1===a?x(e=f(p(e),t,n),t,n,r,i,o,2):2===a&&v(e,t,n,r,i,o):x(p(e),t,n,r,i,o,1);break}}}function l(e){var t=e.prev,n=e,r=e.next;if(!(0<=O(t,n,r))){for(var i=e.next.next;i!==e.prev;){if(M(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=O(i.prev,i,i.next))return;i=i.next}return 1}}function c(e,t,n,r){var i=e.prev,o=e,a=e.next;if(!(0<=O(i,o,a))){for(var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,h=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,u=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,l=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,c=b(s,h,t,n,r),f=b(u,l,t,n,r),v=e.prevZ,d=e.nextZ;v&&v.z>=c&&d&&d.z<=f;){if(v!==e.prev&&v!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=O(v.prev,v,v.next))return;if(v=v.prevZ,d!==e.prev&&d!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=O(d.prev,d,d.next))return;d=d.nextZ}for(;v&&v.z>=c;){if(v!==e.prev&&v!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=O(v.prev,v,v.next))return;v=v.prevZ}for(;d&&d.z<=f;){if(d!==e.prev&&d!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=O(d.prev,d,d.next))return;d=d.nextZ}return 1}}function f(e,t,n){var r=e;do{var i=r.prev,o=r.next.next;!d(i,o)&&j(i,r,r.next,o)&&T(i,o)&&T(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),A(r),A(r.next),r=e=o),r=r.next}while(r!==e);return p(r)}function v(e,t,n,r,i,o){var a,s,h=e;do{for(var u=h.next.next;u!==h.prev;){if(h.i!==u.i&&(s=u,(a=h).next.i!==s.i&&a.prev.i!==s.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&j(n,n.next,e,t))return 1;n=n.next}while(n!==e);return}(a,s)&&(T(a,s)&&T(s,a)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==e;);return r}(a,s)&&(O(a.prev,a,s.prev)||O(a,s.prev,s))||d(a,s)&&0<O(a.prev,a,a.next)&&0<O(s.prev,s,s.next)))){var l=C(h,u);return h=p(h,h.next),l=p(l,l.next),x(h,t,n,r,i,o),void x(l,t,n,r,i,o)}u=u.next}h=h.next}while(h!==e)}function y(e,t){return e.x-t.x}function m(e,t){if(t=function(e,t){var n,r=t,i=e.x,o=e.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&a<s){if((a=s)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(i===a)return n;var h,u=n,l=n.x,c=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=l&&i!==r.x&&M(o<c?i:a,o,l,c,o<c?a:i,o,r.x,r.y)&&(h=Math.abs(o-r.y)/(i-r.x),T(r,e)&&(h<f||h===f&&(r.x>n.x||r.x===n.x&&(d=r,O((v=n).prev,v,d.prev)<0&&O(d.next,v,v.next)<0)))&&(n=r,f=h)),r=r.next,r!==u;);var v,d;return n}(e,t)){var n=C(t,e);p(t,t.next),p(n,n.next)}}function b(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function _(e){for(var t=e,n=e;(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),(t=t.next)!==e;);return n}function M(e,t,n,r,i,o,a,s){return 0<=(i-a)*(t-s)-(e-a)*(o-s)&&0<=(e-a)*(r-s)-(n-a)*(t-s)&&0<=(n-a)*(o-s)-(i-a)*(r-s)}function O(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function d(e,t){return e.x===t.x&&e.y===t.y}function j(e,t,n,r){var i=u(O(e,t,n)),o=u(O(e,t,r)),a=u(O(n,r,e)),s=u(O(n,r,t));return i!==o&&a!==s||(0===i&&h(e,n,t)||(0===o&&h(e,r,t)||(0===a&&h(n,e,r)||!(0!==s||!h(n,t,r)))))}function h(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function u(e){return 0<e?1:e<0?-1:0}function T(e,t){return O(e.prev,e,e.next)<0?0<=O(e,t,e.next)&&0<=O(e,e.prev,t):O(e,t,e.prev)<0||O(e,e.next,t)<0}function C(e,t){var n=new a(e.i,e.x,e.y),r=new a(t.i,t.x,t.y),i=e.next,o=t.prev;return(e.next=t).prev=e,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function s(e,t,n,r){var i=new a(e,t,n);return r?(i.next=r.next,(i.prev=r).next.prev=i,r.next=i):(i.prev=i).next=i,i}function A(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function a(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function S(e,t,n,r){for(var i=0,o=t,a=n-r;o<n;o+=r)i+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return i}function B(e,t,n){var r=t[0],i=t[1],o=n[0]-r,a=n[1]-i;if(0!==o||0!==a){var s=((e[0]-r)*o+(e[1]-i)*a)/(o*o+a*a);1<s?(r=n[0],i=n[1]):0<s&&(r+=o*s,i+=a*s)}return(o=e[0]-r)*o+(a=e[1]-i)*a}function i(e,t){var n=e.length-1,r=[e[0]];return function e(t,n,r,i,o){for(var a,s=i,h=n+1;h<r;h++){var u=B(t[h],t[n],t[r]);s<u&&(a=h,s=u)}i<s&&(1<a-n&&e(t,n,a,i,o),o.push(t[a]),1<r-a&&e(t,a,r,i,o))}(e,0,n,t,r),r.push(e[n]),r}function o(e,t,n){if(e.length<=2)return e;var r=void 0!==t?t*t:1;return e=i(e=n?e:function(e,t){for(var n,r,i,o,a,s=e[0],h=[s],u=1,l=e.length;u<l;u++)n=e[u],i=s,0,o=(r=n)[0]-i[0],a=r[1]-i[1],t<o*o+a*a&&(h.push(n),s=n);return s!==n&&h.push(n),h}(e,r),r)}function z(e,t){var n=t[0],r=t[1],i=Math.sqrt(n*n+r*r);return e[0]=n/i,e[1]=r/i,e}function I(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e}function V(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}n.deviation=function(e,t,n,r){var i=t&&t.length,o=i?t[0]*n:e.length,a=Math.abs(S(e,0,o,n));if(i)for(var s=0,h=t.length;s<h;s++){var u=t[s]*n,l=s<h-1?t[s+1]*n:e.length;a-=Math.abs(S(e,u,l,n))}var c=0;for(s=0;s<r.length;s+=3){var f=r[s]*n,v=r[s+1]*n,d=r[s+2]*n;c+=Math.abs((e[f]-e[d])*(e[1+v]-e[1+f])-(e[f]-e[v])*(e[1+d]-e[1+f]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},n.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var a=0;a<t;a++)n.vertices.push(e[i][o][a]);0<i&&(r+=e[i-1].length,n.holes.push(r))}return n},w.default=t;var k=[];function le(e,t,n,r){var i,o,a,s,h,u,l,c,f,v,d,g=(o=n,(i=t)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),p=Math.acos(g)*r;return I(k,n,t,-g),h=(s=a=k)[0],u=s[1],l=s[2],c=Math.sqrt(h*h+u*u+l*l),a[0]=h/c,a[1]=u/c,a[2]=l/c,f=e,v=t,d=Math.cos(p),f[0]=v[0]*d,f[1]=v[1]*d,f[2]=v[2]*d,I(e,e,k,Math.sin(p)),e}function L(e,t,n){if(n-t<3)return 0;for(var r=0,i=2*(n-1),o=2*t;o<2*n;){var a=e[i],s=e[i+1],h=e[o],u=e[o+1];i=o,o+=2,r+=a*u-h*s}return r}var P=[],E=[],U=[];function Z(e,t,n,r,i,o,a,s){var h,u,l,c,f,v=null!=a,d=i,g=null;v&&(g=new Uint32Array(r-n));for(var p=n;p<r;p++){var x=p===r-1?n:p+1,y=p===n?r-1:p-1,m=e[2*y],b=e[2*y+1],_=e[2*p],w=e[2*p+1],M=e[2*x],O=e[2*x+1];if(P[0]=_-m,P[1]=w-b,E[0]=M-_,E[1]=O-w,z(P,P),z(E,E),v&&(g[p]=d),s||p!==n)if(s||p!==r-1){c=E,f=P,(l=U)[0]=c[0]+f[0],l[1]=c[1]+f[1];var j=U[1];U[1]=-U[0],U[0]=j,z(U,U);var T=(u=E,(h=U)[0]*u[0]+h[1]*u[1]),C=Math.sqrt(1-T*T),A=o*Math.min(10,1/C);if(v&&a<1/C&&o*T<0){var S=_+U[0]*o,B=w+U[1]*o,I=Math.acos(C)/2,V=Math.tan(I)*Math.abs(o);t[2*d]=S+U[1]*V,t[2*d+1]=B-U[0]*V,t[2*++d]=S-U[1]*V,t[2*d+1]=B+U[0]*V,d++}else t[2*d]=_+U[0]*A,t[2*d+1]=w+U[1]*A,d++}else U[0]=P[1],U[1]=-P[0],z(U,U),t[2*d]=_+U[0]*o,t[2*d+1]=w+U[1]*o,d++;else U[0]=E[1],U[1]=-E[0],z(U,U),t[2*d]=_+U[0]*o,t[2*d+1]=w+U[1]*o,d++}return g}function R(e,t,n,r,i){var o=null!=r?[]:new Float32Array(e.length);if(Z(e,o,0,t&&t.length?t[0]:e.length/2,0,n,r,i),t)for(var a=0;a<t.length;a++){var s=t[a];Z(e,o,s,t[a+1]||e.length/2,null!=r?o.length/2:s,n,r,i)}return o}function F(e,t,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<t;o++){var a=(i+n)*t+o,s=(r-i-1)*t+o,h=e[a];e[a]=e[s],e[s]=h}return e}function G(e,t){var n=e.length/2,r=0,i=t&&t.length?t[0]:n;0<L(e,r,i)&&F(e,2,r,i);for(var o=1;o<(t?t.length:0)+1;o++)L(e,r=t[o-1],i=t[o]||n)<0&&F(e,2,r,i)}var ce=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function D(e,t,n,r,i,o){var a=t.vertices,s=t.topVertices,h=t.depth,u=t.rect,l=r-n,c=o.smoothSide?1:2,f=l*c,v=o.smoothBevel?1:2,d=Math.min(h/2,o.bevelSize),g=o.bevelSegments,p=i.vertex,x=Math.max(u.width,u.height);if(0<d)for(var y=[0,0,1],m=[],b=[0,0,-1],_=[],w=0,M=new Float32Array(l),O=0;O<2;O++)for(var j=0===O?h-d:d,T=0;T<=g*v;T++){for(var C=0,A=void 0,S=void 0,B=0;B<l;B++){for(var I=0;I<c;I++){var V=2*((B+I)%l+n);m[0]=a[V]-s[V],m[1]=a[1+V]-s[1+V],m[2]=0;var z=Math.sqrt(m[0]*m[0]+m[1]*m[1]);m[0]/=z,m[1]/=z;var k=(Math.floor(T/v)+T%v)/g;0===O?le(_,y,m,k):le(_,m,b,k);var L=0===O?k:1-k,P=d*Math.sin(L*Math.PI/2),E=z*Math.cos(L*Math.PI/2),U=d*z/Math.sqrt(P*P+E*E),Z=_[0]*U+s[V],R=_[1]*U+s[1+V],F=_[2]*U+j;if(e.position[3*i.vertex]=Z,e.position[3*i.vertex+1]=R,e.position[3*i.vertex+2]=F,(0<B||0<I)&&(C+=Math.sqrt((A-Z)*(A-Z)+(S-R)*(S-R))),0<T||0<O){var G=3*(i.vertex-f),D=e.position[G],W=e.position[1+G],K=e.position[2+G];M[B]+=Math.sqrt((D-Z)*(D-Z)+(W-R)*(W-R)+(K-F)*(K-F))}e.uv[2*i.vertex]=C/x,e.uv[2*i.vertex+1]=M[B]/x,A=Z,S=R,i.vertex++}if(1<v&&T%v||1==v&&1<=T)for(var q=0;q<6;q++){var H=(ce[q][0]+B*c)%f,N=ce[q][1]+w;e.indices[i.index++]=(N-1)*f+H+p}}w++}else for(var Q=0;Q<2;Q++)for(var X=0===Q?h-d:d,Y=0,J=void 0,$=void 0,ee=0;ee<l;ee++)for(var te=0;te<c;te++){var ne=2*((ee+te)%l+n),re=a[ne],ie=a[1+ne];e.position[3*i.vertex]=re,e.position[3*i.vertex+1]=ie,e.position[3*i.vertex+2]=X,(0<ee||0<te)&&(Y+=Math.sqrt((J-re)*(J-re)+($-ie)*($-ie))),e.uv[2*i.vertex]=Y/x,e.uv[2*i.vertex+1]=X/x,J=re,$=ie,i.vertex++}for(var oe=0<d?g*v+1:1,ae=0;ae<l;ae++)for(var se=0;se<6;se++){var he=(ce[se][0]+ae*c)%f,ue=ce[se][1]+oe;e.indices[i.index++]=(ue-1)*f+he+p}}function W(e,t,n,r){var i=e.indices,o=e.vertices,a=e.topVertices,s=e.rect,h=e.depth;if(!(o.length<=4)){for(var u=n.vertex,l=i.length,c=0;c<l;c++)t.indices[n.index++]=u+i[c];for(var f=Math.max(s.width,s.height),v=0;v<(r.excludeBottom?1:2);v++)for(var d=0;d<a.length;d+=2){var g=a[d],p=a[d+1];t.position[3*n.vertex]=g,t.position[3*n.vertex+1]=p,t.position[3*n.vertex+2]=(1-v)*h,t.uv[2*n.vertex]=(g-s.x)/f,t.uv[2*n.vertex+1]=(p-s.y)/f,n.vertex++}if(!r.excludeBottom)for(var x=o.length/2,y=0;y<l;y+=3)for(var m=0;m<3;m++)t.indices[n.index++]=u+x+i[y+2-m]}}function K(e,t){for(var n=0,r=0,i=0;i<e.length;i++){var o=e[i],a=o.indices,s=o.vertices,h=o.holes,u=o.depth,l=s.length/2,c=0<Math.min(u/2,t.bevelSize)?t.bevelSegments:0;n+=a.length*(t.excludeBottom?1:2),r+=l*(t.excludeBottom?1:2);for(var f=2+2*c,v=0,d=0,g=0;g<(h?h.length:0)+1;g++){n+=6*((d=0===g?h&&h.length?h[0]:l:(v=h[g-1],h[g]||l))-v)*(f-1);var p=(d-v)*(t.smoothSide?1:2);r+=p*f+(t.smoothBevel?0:c*p*2)}}for(var x={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},y={vertex:0,index:0},m=0;m<e.length;m++)W(e[m],x,y,t);for(var b=0;b<e.length;b++){var _=e[b],w=_.holes,M=_.vertices.length/2,O=0,j=w&&w.length?w[0]:M;if(D(x,e[b],O,j,y,t),w)for(var T=0;T<w.length;T++)O=w[T],j=w[T+1]||M,D(x,e[b],O,j,y,t)}for(var C=0;C<x.uv.length;C++){var A=x.uv[C];0<A&&Math.round(A)===A?x.uv[C]=1:x.uv[C]=A%1}return x.normal=function(e,t){function n(e,t,n,r){e[0]=t,e[1]=n,e[2]=r}for(var r,i,o,a,s,h,u,l,c,f,v,d,g,p,x,y=[],m=[],b=[],_=[],w=[],M=[],O=e.length,j=new Float32Array(t.length),T=0;T<O;){var C=3*e[T++],A=3*e[T++],S=3*e[T++];n(y,t[C],t[1+C],t[2+C]),n(m,t[A],t[1+A],t[2+A]),n(b,t[S],t[1+S],t[2+S]),V(_,y,m),V(w,m,b),r=M,o=w,0,a=(i=_)[0],s=i[1],h=i[2],u=o[0],l=o[1],c=o[2],r[0]=s*c-h*l,r[1]=h*u-a*c,r[2]=a*l-s*u;for(var B=0;B<3;B++)j[C+B]=j[C+B]+M[B],j[A+B]=j[A+B]+M[B],j[S+B]=j[S+B]+M[B]}for(var I=0;I<j.length;)n(M,j[I],j[I+1],j[I+2]),0,d=(v=f=M)[0],g=v[1],p=v[2],x=Math.sqrt(d*d+g*g+p*p),f[0]=d/x,f[1]=g/x,f[2]=p/x,j[I++]=M[0],j[I++]=M[1],j[I++]=M[2];return j}(x.indices,x.position),x.boundingRect=e[0]&&e[0].rect,x}function q(e,t){for(var n=[],r=0;r<e.length;r++){for(var i=e[r],o=[],a=i.length,s=i[a-1][0],h=i[a-1][1],u=0,l=0;l<a;l++){var c=i[l][0],f=i[l][1],v=c-s,d=f-h;t<(u+=Math.sqrt(v*v+d*d))&&(o.push(i[l]),u=0),s=c,h=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}function H(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r];3<=(i=o(i,t,!0)).length&&n.push(i)}return 0<n.length?n:null}function N(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)Q(e[i][0],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},function(e){e.depth=e.depth||1,e.bevelSize=e.bevelSize||0,e.bevelSegments=null==e.bevelSegments?2:e.bevelSegments,e.smoothSide=e.smoothSide||!1,e.smoothBevel=e.smoothBevel||!1,e.simplify=e.simplify||0,"number"==typeof e.depth&&(e.bevelSize=Math.min(0<e.bevelSegments?e.bevelSize:0,e.depth/2)),0<e.bevelSize||(e.bevelSegments=0),e.bevelSegments=Math.round(e.bevelSegments);var t=e.boundingRect;if(e.translate=e.translate||[0,0],e.scale=e.scale||[1,1],e.fitRect){var n=null==e.fitRect.x?t.x||0:e.fitRect.x,r=null==e.fitRect.y?t.y||0:e.fitRect.y,i=e.fitRect.width,o=e.fitRect.height;null==i?null!=o?i=o/t.height*t.width:(i=t.width,o=t.height):null==o&&(o=i/t.width*t.height),e.scale=[i/t.width,o/t.height],e.translate=[(n-t.x)*e.scale[0],(r-t.y)*e.scale[1]]}}(t);for(var o,a=[],s=t.translate||[0,0],h=t.scale||[1,1],u=t.boundingRect,l={x:u.x*h[0]+s[0],y:u.y*h[1]+s[1],width:u.width*h[0],height:u.height*h[1]},c=Math.min(u.width,u.height)/1e5,f=0;f<e.length;f++){var v=q(e[f],c);if(v){var d=t.simplify/Math.max(h[0],h[1]);if(0<d&&(v=H(v,d)),v){for(var g=w.flatten(v),p=g.vertices,x=g.holes,y=g.dimensions,m=0;m<p.length;)p[m]=p[m++]*h[0]+s[0],p[m]=p[m++]*h[1]+s[1];if(G(p,x),2!==y)throw new Error("Only 2D polygon points are supported");var b=0<t.bevelSize?R(p,x,t.bevelSize,null,!0):p,_=(void 0===(o=y)&&(o=2),w(b,x,o));a.push({indices:_,vertices:p,topVertices:b,holes:x,rect:l,depth:"function"==typeof t.depth?t.depth(f):t.depth})}}}return K(a,t)}function Q(e,t,n){for(var r=0;r<e.length;r++)t[0]=Math.min(e[r][0],t[0]),t[1]=Math.min(e[r][1],t[1]),n[0]=Math.max(e[r][0],n[0]),n[1]=Math.max(e[r][1],n[1])}function X(e){for(var t=new Float32Array(e),n=[],r=0,i=t.length;r<i;r+=2){var o=t[r],a=t[r+1];n.push([o,a])}return n}function Y(e){for(var t=0,n=0;n<e.length;++n){t+=e[n].length}for(var r=new Float32Array(t),i=0,o=0;o<e.length;++o)r.set(e[o],i),i+=e[o].length;return r}e.initialize=function(){},e.onmessage=function(e,t){var n=e.data,r=n.type,i=n.datas;if("Polygon"===r){!function(e){for(var t=e.length,n=0;n<t;n++)for(var r=e[n].data,i=0,o=r.length;i<o;i++)for(var a=r[i],s=0,h=a.length;s<h;s++)e[n].data[i][s]=X(a[s])}(i);var o=function(e){for(var t=e.length,n=[],r=[],i=[],o=0,a=0,s=0,h=0,u=0;u<t;u++){var l=(m=e[u],0,b=m.data,_=m.height,w=N(b,{depth:_}),M=w.position,O=w.normal,j=w.uv,T=w.indices,{position:M,normal:O,uv:j,indices:T}),c=l.position,f=l.normal,v=l.uv,d=l.indices;r.push(l);var g=d.length/3;i[u]=[o+1,o+g],o+=g;var p=c.length/3,x=f.length/3,y=v.length/2;n[u]={position:{count:p,start:a,end:a+3*p},normal:{count:x,start:s,end:s+3*x},uv:{count:y,start:h,end:h+2*y},hide:!1},a+=3*p,s+=3*x,h+=2*y}var m,b,_,w,M,O,j,T;var C=function(e){for(var t={},n=0;n<e.length;++n){var r=e[n];for(var i in r)void 0===t[i]&&(t[i]=[]),t[i].push(r[i])}var o={},a=0,s=[];for(var h in t)if("indices"===h)for(var u=t[h],l=0,c=u.length;l<c;l++){for(var f=u[l],v=0,d=f.length;v<d;v++)s.push(f[v]+a);a+=t.position[l].length/3}else{var g=Y(t[h]);if(!g)return null;o[h]=g}return o.indices=new Uint32Array(s),o}(r),A=C.position,S=C.normal,B=C.uv,I=C.indices;return{position:A.buffer,normal:S.buffer,uv:B.buffer,indices:I.buffer,faceMap:i,geometriesAttributes:n}}(i);t(null,o,[o.position,o.normal,o.uv,o.indices])}},Object.defineProperty(e,"__esModule",{value:!0})},t?n(r?module.exports:ue,ue):ue&&ue.registerWorkerAdapter?(ue.registerWorkerAdapter("maptalks.three",n),t=!0):console.warn("maptalks.registerWorkerAdapter is not defined,If you need to use ThreeVectorTileLayer,you can npm i maptalks@next,more https://github.com/maptalks/maptalks.js/tree/next");var o=function(e){function t(){return e.apply(this,arguments)||this}return i(t,e),t.prototype.addTo=function(e){if(e instanceof l)return e.on("mousemove",this.onMouseMove,this),e.on("mouseout",this.onMouseOut,this),this._owner=e,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this;throw new Error("Invalid BaseObject the tooltip is added to.")},t}(ue.ui.ToolTip),a={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1},l=function(n){function e(e){var t;return(t=n.call(this)||this).isBaseObject=!0,t.isAdd=!1,t.object3d=null,t.options={},t.toolTip=null,t.infoWindow=null,t._mouseover=!1,t._showPlayer=null,t._vt=null,void 0===e&&(e=ue.Util.GUID()),t.id=e,t}i(e,n);var t=e.prototype;return t.addTo=function(e){return e instanceof Qt?e.addMesh(this):console.error("layer only support maptalks.ThreeLayer"),this},t.remove=function(){var e=this.getLayer();return e&&e.removeMesh(this),this},t.getObject3d=function(){return this.object3d},t.getId=function(){return this.id},t.setId=function(e){var t=this.getId();return this.id=e,this._fire("idchange",{old:t,new:e,target:this}),this},t.getType=function(){return this.constructor.name},t.getOptions=function(){return this.options},t.getProperties=function(){return(this.options||{}).properties},t.setProperties=function(e){var t=Object.assign({},this.getProperties());return this.options.properties=e,this._fire("propertieschange",{old:t,new:e,target:this}),this},t.getLayer=function(){return this.options.layer},t.getMap=function(){var e=this.getLayer();if(e)return e.getMap()},t.getCenter=function(){var e=this.getOptions(),t=e.coordinate,n=e.lineString,r=e.polygon;if(t)return t;var i=r||n;return i&&i.getCenter?i.getCenter():void 0},t.getAltitude=function(){return this.getOptions().altitude},t.setAltitude=function(e){if(ue.Util.isNumber(e)){var t=this.getLayer().distanceToVector3(e,e).x;this.getObject3d().position.z=t,this.options.altitude=e}return this},t.show=function(){return this.getObject3d().visible=!0,this._fire("show"),this},t.hide=function(){return this.getObject3d().visible=!1,this._fire("hide"),this},t.isVisible=function(){return!!this.getObject3d().visible},t.getSymbol=function(){return this.getObject3d().material},t.setSymbol=function(e){if(e&&e instanceof le.Material){e.needsUpdate=!0,e.vertexColors=this.getObject3d().material.vertexColors;var t=this.getObject3d().material.clone();this.getObject3d().material=e,this._fire("symbolchange",{old:t,new:e,target:this})}return this},t.setInfoWindow=function(e){return this.infoWindow=new ue.ui.InfoWindow(e),this},t.getInfoWindow=function(){return this.infoWindow},t.openInfoWindow=function(e){return e&&this.infoWindow&&this.infoWindow.show(e),this},t.closeInfoWindow=function(){return this.infoWindow&&this.infoWindow.hide(),this},t.removeInfoWindow=function(){return this.infoWindow&&this.infoWindow.remove()&&delete this.infoWindow,this},t.setToolTip=function(e,t){return this.toolTip=new o(e,t),this},t.getToolTip=function(){return this.toolTip},t.openToolTip=function(e){return e&&this.toolTip&&this.toolTip.show(e),this},t.closeToolTip=function(){return this.toolTip&&this.toolTip.hide(),this},t.removeToolTip=function(){return this.toolTip&&this.toolTip.remove()&&delete this.toolTip,this},t.animateShow=function(e,n){var r=this;void 0===e&&(e={}),this._showPlayer&&this._showPlayer.cancel(),ue.Util.isFunction(e)&&(n=e={});var t=e.duration||1e3,i=e.easing||"out",o=this._showPlayer=ue.animation.Animation.animate({scale:1},{duration:t,easing:i},function(e){var t=e.styles.scale;0<t&&r.getObject3d().scale.set(1,1,t),n&&n(e,t)});return o.play(),o},t.getMinZoom=function(){return this.getOptions().minZoom},t.getMaxZoom=function(){return this.getOptions().maxZoom},t.isAsynchronous=function(){return this.getOptions().asynchronous},t.fire=function(e,t){return this._fire(e,t),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(e,t),this},t.config=function(){return this},t._initOptions=function(e){return this.options=ue.Util.extend({},a,e),this},t._createMesh=function(e,t){return this.object3d=new le.Mesh(e,t),this.object3d.__parent=this},t._createGroup=function(){return this.object3d=new le.Group,this.object3d.__parent=this},t._createLine=function(e,t){return this.object3d=new le.Line(e,t),this.object3d.computeLineDistances(),this.object3d.__parent=this},t._createPoints=function(e,t){return this.object3d=new le.Points(e,t),this.object3d.__parent=this},t._createLineSegments=function(e,t){return this.object3d=new le.LineSegments(e,t),this.object3d.computeLineDistances(),this.object3d.__parent=this},e}(ue.Eventable(function(){})),s=parseInt(le.REVISION);function ce(e,t,n){return 109<s?e.setAttribute(t,n):e.addAttribute(t,n),e}function Z(e){for(var t={},n=0;n<e.length;++n){var r=e[n];for(var i in r)void 0===t[i]&&(t[i]=[]),t[i].push(r[i])}var o={},a=0,s=[];for(var h in t)if("indices"===h)for(var u=t[h],l=0,c=u.length;l<c;l++){for(var f=u[l],v=0,d=f.length;v<d;v++)s.push(f[v]+a);a+=t.position[l].length/3}else{var g=w(t[h]);if(!g)return null;o[h]=g}o.indices=new Uint32Array(s);var p=o.position,x=o.normal,y=o.uv,m=o.indices,b=new le.BufferGeometry,_=new Float32Array(p.length);return _.fill(1,0,p.length),ce(b,"color",new le.BufferAttribute(_,3)),ce(b,"normal",new le.BufferAttribute(x,3)),ce(b,"position",new le.BufferAttribute(p,3)),y&&y.length&&ce(b,"uv",new le.BufferAttribute(y,2)),b.setIndex(new le.BufferAttribute(m,1)),b}function w(e){for(var t=0,n=0;n<e.length;++n){t+=e[n].length}for(var r=new Float32Array(t),i=0,o=0;o<e.length;++o)r.set(e[o],i),i+=e[o].length;return r}var y={},m="-";function R(e,t){void 0===t&&(t=!0);var n,r=e.height,i=e.radialSegments,o=e.radius,a=e._radius,s=e._height;if(!t){var h=new le.CylinderBufferGeometry(o,o,r,i,1);h.rotateX(Math.PI/2);for(var u=h.attributes.position.array,l=0,c=u.length;l<c;l+=3)u[l+2]+=r/2;return h}for(var f=0;f<=4;f++){var v=[s+f,a,i].join(m).toString();if(n=y[v])break;if(v=[s-f,a,i].join(m).toString(),n=y[v])break}if(n)return n;var d=[s,a,i].join(m).toString();(n=y[d]=new le.CylinderBufferGeometry(o,o,r,i,1)).rotateX(Math.PI/2);for(var g=n.attributes.position.array,p=0,x=g.length;p<x;p+=3)g[p+2]+=r/2;return n}function F(e,t,n,r,i){void 0===r&&(r="y"),void 0===i&&(i=0);var o=0;"y"===r?o=1:"z"===r&&(o=2);for(var a=e.attributes.position.array,s=a.length,h=t instanceof le.Color?t:new le.Color(t),u=new le.Color(n),l=[],c=0;c<s;c+=3){i<a[c+o]?l.push(u.r,u.r,u.b):l.push(h.r,h.r,h.b)}return ce(e,"color",new le.Float32BufferAttribute(l,3,!0)),l}var d={radius:10,height:100,radialSegments:6,altitude:0,topColor:null,bottomColor:"#2d2f61"},G=function(v){function e(e,t,n,r){var i;t=ue.Util.extend({},d,t,{layer:r,coordinate:e}),(i=v.call(this)||this)._initOptions(t);var o=t.height,a=t.radius,s=t.topColor,h=t.bottomColor,u=t.altitude;t.height=r.distanceToVector3(o,o).x,t.radius=r.distanceToVector3(a,a).x,t._radius=i.options.radius,t._height=i.options.height,i._h=t.height;var l=R(t);s&&!n.map&&(F(l,h,s,"z",t.height/2),n.vertexColors=le.VertexColors),i._createMesh(l,n);var c=r.distanceToVector3(u,u).x,f=r.coordinateToVector3(e,c);return i.getObject3d().position.copy(f),i}return i(e,v),e}(l),M=u,h=u;function u(e,t,n){n=n||2;var r,i,o,a,s,h,u,l=t&&t.length,c=l?t[0]*n:e.length,f=g(e,0,c,n,!0),v=[];if(!f||f.next===f.prev)return v;if(l&&(f=function(e,t,n,r){var i,o,a,s,h,u=[];for(i=0,o=t.length;i<o;i++)a=t[i]*r,s=i<o-1?t[i+1]*r:e.length,(h=g(e,a,s,r,!1))===h.next&&(h.steiner=!0),u.push(T(h));for(u.sort(_),i=0;i<u.length;i++)O(u[i],n),n=p(n,n.next);return n}(e,t,f,n)),e.length>80*n){r=o=e[0],i=a=e[1];for(var d=n;d<c;d+=n)(s=e[d])<r&&(r=s),(h=e[d+1])<i&&(i=h),o<s&&(o=s),a<h&&(a=h);u=0!==(u=Math.max(o-r,a-i))?1/u:0}return x(f,v,n,r,i,u),v}function g(e,t,n,r,i){var o,a;if(i===0<U(e,t,n,r))for(o=t;o<n;o+=r)a=L(o,e[o],e[o+1],a);else for(o=n-r;t<=o;o-=r)a=L(o,e[o],e[o+1],a);return a&&S(a,a.next)&&(P(a),a=a.next),a}function p(e,t){if(!e)return e;t=t||e;var n,r=e;do{if(n=!1,r.steiner||!S(r,r.next)&&0!==A(r.prev,r,r.next))r=r.next;else{if(P(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function x(e,t,n,r,i,o,a){if(e){!a&&o&&function(e,t,n,r){var i=e;for(;null===i.z&&(i.z=j(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==e;);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,o,a,s,h,u=1;do{for(n=e,o=e=null,a=0;n;){for(a++,r=n,t=s=0;t<u&&(s++,r=r.nextZ);t++);for(h=u;0<s||0<h&&r;)0!==s&&(0===h||!r||n.z<=r.z)?(n=(i=n).nextZ,s--):(r=(i=r).nextZ,h--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;n=r}o.nextZ=null,u*=2}while(1<a)}(i)}(e,r,i,o);for(var s,h,u=e;e.prev!==e.next;)if(s=e.prev,h=e.next,o?f(e,r,i,o):c(e))t.push(s.i/n),t.push(e.i/n),t.push(h.i/n),P(e),e=h.next,u=h.next;else if((e=h)===u){a?1===a?x(e=v(p(e),t,n),t,n,r,i,o,2):2===a&&b(e,t,n,r,i,o):x(p(e),t,n,r,i,o,1);break}}}function c(e){var t=e.prev,n=e,r=e.next;if(!(0<=A(t,n,r))){for(var i=e.next.next;i!==e.prev;){if(C(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=A(i.prev,i,i.next))return;i=i.next}return 1}}function f(e,t,n,r){var i=e.prev,o=e,a=e.next;if(!(0<=A(i,o,a))){for(var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,h=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,u=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,l=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,c=j(s,h,t,n,r),f=j(u,l,t,n,r),v=e.prevZ,d=e.nextZ;v&&v.z>=c&&d&&d.z<=f;){if(v!==e.prev&&v!==e.next&&C(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=A(v.prev,v,v.next))return;if(v=v.prevZ,d!==e.prev&&d!==e.next&&C(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=A(d.prev,d,d.next))return;d=d.nextZ}for(;v&&v.z>=c;){if(v!==e.prev&&v!==e.next&&C(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=A(v.prev,v,v.next))return;v=v.prevZ}for(;d&&d.z<=f;){if(d!==e.prev&&d!==e.next&&C(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=A(d.prev,d,d.next))return;d=d.nextZ}return 1}}function v(e,t,n){var r=e;do{var i=r.prev,o=r.next.next;!S(i,o)&&B(i,r,r.next,o)&&z(i,o)&&z(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),P(r),P(r.next),r=e=o),r=r.next}while(r!==e);return p(r)}function b(e,t,n,r,i,o){var a,s,h=e;do{for(var u=h.next.next;u!==h.prev;){if(h.i!==u.i&&(s=u,(a=h).next.i!==s.i&&a.prev.i!==s.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&B(n,n.next,e,t))return 1;n=n.next}while(n!==e);return}(a,s)&&(z(a,s)&&z(s,a)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==e;);return r}(a,s)&&(A(a.prev,a,s.prev)||A(a,s.prev,s))||S(a,s)&&0<A(a.prev,a,a.next)&&0<A(s.prev,s,s.next)))){var l=k(h,u);return h=p(h,h.next),l=p(l,l.next),x(h,t,n,r,i,o),void x(l,t,n,r,i,o)}u=u.next}h=h.next}while(h!==e)}function _(e,t){return e.x-t.x}function O(e,t){if(t=function(e,t){var n,r=t,i=e.x,o=e.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&a<s){if((a=s)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(i===a)return n;var h,u=n,l=n.x,c=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=l&&i!==r.x&&C(o<c?i:a,o,l,c,o<c?a:i,o,r.x,r.y)&&(h=Math.abs(o-r.y)/(i-r.x),z(r,e)&&(h<f||h===f&&(r.x>n.x||r.x===n.x&&(d=r,A((v=n).prev,v,d.prev)<0&&A(d.next,v,v.next)<0)))&&(n=r,f=h)),r=r.next,r!==u;);var v,d;return n}(e,t)){var n=k(t,e);p(t,t.next),p(n,n.next)}}function j(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function T(e){for(var t=e,n=e;(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),(t=t.next)!==e;);return n}function C(e,t,n,r,i,o,a,s){return 0<=(i-a)*(t-s)-(e-a)*(o-s)&&0<=(e-a)*(r-s)-(n-a)*(t-s)&&0<=(n-a)*(o-s)-(i-a)*(r-s)}function A(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function S(e,t){return e.x===t.x&&e.y===t.y}function B(e,t,n,r){var i=V(A(e,t,n)),o=V(A(e,t,r)),a=V(A(n,r,e)),s=V(A(n,r,t));return i!==o&&a!==s||(0===i&&I(e,n,t)||(0===o&&I(e,r,t)||(0===a&&I(n,e,r)||!(0!==s||!I(n,t,r)))))}function I(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function V(e){return 0<e?1:e<0?-1:0}function z(e,t){return A(e.prev,e,e.next)<0?0<=A(e,t,e.next)&&0<=A(e,e.prev,t):A(e,t,e.prev)<0||A(e,e.next,t)<0}function k(e,t){var n=new E(e.i,e.x,e.y),r=new E(t.i,t.x,t.y),i=e.next,o=t.prev;return(e.next=t).prev=e,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function L(e,t,n,r){var i=new E(e,t,n);return r?(i.next=r.next,(i.prev=r).next.prev=i,r.next=i):(i.prev=i).next=i,i}function P(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function E(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function U(e,t,n,r){for(var i=0,o=t,a=n-r;o<n;o+=r)i+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return i}function D(e,t,n){var r=t[0],i=t[1],o=n[0]-r,a=n[1]-i;if(0!==o||0!==a){var s=((e[0]-r)*o+(e[1]-i)*a)/(o*o+a*a);1<s?(r=n[0],i=n[1]):0<s&&(r+=o*s,i+=a*s)}return(o=e[0]-r)*o+(a=e[1]-i)*a}function W(e,t){var n=e.length-1,r=[e[0]];return function e(t,n,r,i,o){for(var a,s=i,h=n+1;h<r;h++){var u=D(t[h],t[n],t[r]);s<u&&(a=h,s=u)}i<s&&(1<a-n&&e(t,n,a,i,o),o.push(t[a]),1<r-a&&e(t,a,r,i,o))}(e,0,n,t,r),r.push(e[n]),r}function K(e,t,n){if(e.length<=2)return e;var r=void 0!==t?t*t:1;return e=W(e=n?e:function(e,t){for(var n,r,i,o,a,s=e[0],h=[s],u=1,l=e.length;u<l;u++)n=e[u],i=s,0,o=(r=n)[0]-i[0],a=r[1]-i[1],t<o*o+a*a&&(h.push(n),s=n);return s!==n&&h.push(n),h}(e,r),r)}function q(e,t){var n=t[0],r=t[1],i=Math.sqrt(n*n+r*r);return e[0]=n/i,e[1]=r/i,e}function H(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e}function N(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}u.deviation=function(e,t,n,r){var i=t&&t.length,o=i?t[0]*n:e.length,a=Math.abs(U(e,0,o,n));if(i)for(var s=0,h=t.length;s<h;s++){var u=t[s]*n,l=s<h-1?t[s+1]*n:e.length;a-=Math.abs(U(e,u,l,n))}var c=0;for(s=0;s<r.length;s+=3){var f=r[s]*n,v=r[s+1]*n,d=r[s+2]*n;c+=Math.abs((e[f]-e[d])*(e[1+v]-e[1+f])-(e[f]-e[v])*(e[1+d]-e[1+f]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},u.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var a=0;a<t;a++)n.vertices.push(e[i][o][a]);0<i&&(r+=e[i-1].length,n.holes.push(r))}return n},M.default=h;var Q=[];function fe(e,t,n,r){var i,o,a,s,h,u,l,c,f,v,d,g=(o=n,(i=t)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),p=Math.acos(g)*r;return H(Q,n,t,-g),h=(s=a=Q)[0],u=s[1],l=s[2],c=Math.sqrt(h*h+u*u+l*l),a[0]=h/c,a[1]=u/c,a[2]=l/c,f=e,v=t,d=Math.cos(p),f[0]=v[0]*d,f[1]=v[1]*d,f[2]=v[2]*d,H(e,e,Q,Math.sin(p)),e}function X(e,t,n){if(n-t<3)return 0;for(var r=0,i=2*(n-1),o=2*t;o<2*n;){var a=e[i],s=e[i+1],h=e[o],u=e[o+1];i=o,o+=2,r+=a*u-h*s}return r}var Y=[],J=[],$=[];function ee(e,t,n,r,i,o,a,s){var h,u,l,c,f,v=null!=a,d=i,g=null;v&&(g=new Uint32Array(r-n));for(var p=n;p<r;p++){var x=p===r-1?n:p+1,y=p===n?r-1:p-1,m=e[2*y],b=e[2*y+1],_=e[2*p],w=e[2*p+1],M=e[2*x],O=e[2*x+1];if(Y[0]=_-m,Y[1]=w-b,J[0]=M-_,J[1]=O-w,q(Y,Y),q(J,J),v&&(g[p]=d),s||p!==n)if(s||p!==r-1){c=J,f=Y,(l=$)[0]=c[0]+f[0],l[1]=c[1]+f[1];var j=$[1];$[1]=-$[0],$[0]=j,q($,$);var T=(u=J,(h=$)[0]*u[0]+h[1]*u[1]),C=Math.sqrt(1-T*T),A=o*Math.min(10,1/C);if(v&&a<1/C&&o*T<0){var S=_+$[0]*o,B=w+$[1]*o,I=Math.acos(C)/2,V=Math.tan(I)*Math.abs(o);t[2*d]=S+$[1]*V,t[2*d+1]=B-$[0]*V,t[2*++d]=S-$[1]*V,t[2*d+1]=B+$[0]*V,d++}else t[2*d]=_+$[0]*A,t[2*d+1]=w+$[1]*A,d++}else $[0]=Y[1],$[1]=-Y[0],q($,$),t[2*d]=_+$[0]*o,t[2*d+1]=w+$[1]*o,d++;else $[0]=J[1],$[1]=-J[0],q($,$),t[2*d]=_+$[0]*o,t[2*d+1]=w+$[1]*o,d++}return g}function te(e,t,n,r,i){var o=null!=r?[]:new Float32Array(e.length);if(ee(e,o,0,t&&t.length?t[0]:e.length/2,0,n,r,i),t)for(var a=0;a<t.length;a++){var s=t[a];ee(e,o,s,t[a+1]||e.length/2,null!=r?o.length/2:s,n,r,i)}return o}function ne(e,t,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<t;o++){var a=(i+n)*t+o,s=(r-i-1)*t+o,h=e[a];e[a]=e[s],e[s]=h}return e}function re(e,t){var n=e.length/2,r=0,i=t&&t.length?t[0]:n;0<X(e,r,i)&&ne(e,2,r,i);for(var o=1;o<(t?t.length:0)+1;o++)X(e,r=t[o-1],i=t[o]||n)<0&&ne(e,2,r,i)}function ie(e){e.depth=e.depth||1,e.bevelSize=e.bevelSize||0,e.bevelSegments=null==e.bevelSegments?2:e.bevelSegments,e.smoothSide=e.smoothSide||!1,e.smoothBevel=e.smoothBevel||!1,e.simplify=e.simplify||0,"number"==typeof e.depth&&(e.bevelSize=Math.min(0<e.bevelSegments?e.bevelSize:0,e.depth/2)),0<e.bevelSize||(e.bevelSegments=0),e.bevelSegments=Math.round(e.bevelSegments);var t=e.boundingRect;if(e.translate=e.translate||[0,0],e.scale=e.scale||[1,1],e.fitRect){var n=null==e.fitRect.x?t.x||0:e.fitRect.x,r=null==e.fitRect.y?t.y||0:e.fitRect.y,i=e.fitRect.width,o=e.fitRect.height;null==i?null!=o?i=o/t.height*t.width:(i=t.width,o=t.height):null==o&&(o=i/t.width*t.height),e.scale=[i/t.width,o/t.height],e.translate=[(n-t.x)*e.scale[0],(r-t.y)*e.scale[1]]}}var ve=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function oe(e,t,n,r,i,o){var a=t.vertices,s=t.topVertices,h=t.depth,u=t.rect,l=r-n,c=o.smoothSide?1:2,f=l*c,v=o.smoothBevel?1:2,d=Math.min(h/2,o.bevelSize),g=o.bevelSegments,p=i.vertex,x=Math.max(u.width,u.height);if(0<d)for(var y=[0,0,1],m=[],b=[0,0,-1],_=[],w=0,M=new Float32Array(l),O=0;O<2;O++)for(var j=0===O?h-d:d,T=0;T<=g*v;T++){for(var C=0,A=void 0,S=void 0,B=0;B<l;B++){for(var I=0;I<c;I++){var V=2*((B+I)%l+n);m[0]=a[V]-s[V],m[1]=a[1+V]-s[1+V],m[2]=0;var z=Math.sqrt(m[0]*m[0]+m[1]*m[1]);m[0]/=z,m[1]/=z;var k=(Math.floor(T/v)+T%v)/g;0===O?fe(_,y,m,k):fe(_,m,b,k);var L=0===O?k:1-k,P=d*Math.sin(L*Math.PI/2),E=z*Math.cos(L*Math.PI/2),U=d*z/Math.sqrt(P*P+E*E),Z=_[0]*U+s[V],R=_[1]*U+s[1+V],F=_[2]*U+j;if(e.position[3*i.vertex]=Z,e.position[3*i.vertex+1]=R,e.position[3*i.vertex+2]=F,(0<B||0<I)&&(C+=Math.sqrt((A-Z)*(A-Z)+(S-R)*(S-R))),0<T||0<O){var G=3*(i.vertex-f),D=e.position[G],W=e.position[1+G],K=e.position[2+G];M[B]+=Math.sqrt((D-Z)*(D-Z)+(W-R)*(W-R)+(K-F)*(K-F))}e.uv[2*i.vertex]=C/x,e.uv[2*i.vertex+1]=M[B]/x,A=Z,S=R,i.vertex++}if(1<v&&T%v||1==v&&1<=T)for(var q=0;q<6;q++){var H=(ve[q][0]+B*c)%f,N=ve[q][1]+w;e.indices[i.index++]=(N-1)*f+H+p}}w++}else for(var Q=0;Q<2;Q++)for(var X=0===Q?h-d:d,Y=0,J=void 0,$=void 0,ee=0;ee<l;ee++)for(var te=0;te<c;te++){var ne=2*((ee+te)%l+n),re=a[ne],ie=a[1+ne];e.position[3*i.vertex]=re,e.position[3*i.vertex+1]=ie,e.position[3*i.vertex+2]=X,(0<ee||0<te)&&(Y+=Math.sqrt((J-re)*(J-re)+($-ie)*($-ie))),e.uv[2*i.vertex]=Y/x,e.uv[2*i.vertex+1]=X/x,J=re,$=ie,i.vertex++}for(var oe=0<d?g*v+1:1,ae=0;ae<l;ae++)for(var se=0;se<6;se++){var he=(ve[se][0]+ae*c)%f,ue=ve[se][1]+oe;e.indices[i.index++]=(ue-1)*f+he+p}}function ae(e,t,n,r){var i=e.indices,o=e.vertices,a=e.topVertices,s=e.rect,h=e.depth;if(!(o.length<=4)){for(var u=n.vertex,l=i.length,c=0;c<l;c++)t.indices[n.index++]=u+i[c];for(var f=Math.max(s.width,s.height),v=0;v<(r.excludeBottom?1:2);v++)for(var d=0;d<a.length;d+=2){var g=a[d],p=a[d+1];t.position[3*n.vertex]=g,t.position[3*n.vertex+1]=p,t.position[3*n.vertex+2]=(1-v)*h,t.uv[2*n.vertex]=(g-s.x)/f,t.uv[2*n.vertex+1]=(p-s.y)/f,n.vertex++}if(!r.excludeBottom)for(var x=o.length/2,y=0;y<l;y+=3)for(var m=0;m<3;m++)t.indices[n.index++]=u+x+i[y+2-m]}}function se(e,t){for(var n=0,r=0,i=0;i<e.length;i++){var o=e[i],a=o.indices,s=o.vertices,h=o.holes,u=o.depth,l=s.length/2,c=0<Math.min(u/2,t.bevelSize)?t.bevelSegments:0;n+=a.length*(t.excludeBottom?1:2),r+=l*(t.excludeBottom?1:2);for(var f=2+2*c,v=0,d=0,g=0;g<(h?h.length:0)+1;g++){n+=6*((d=0===g?h&&h.length?h[0]:l:(v=h[g-1],h[g]||l))-v)*(f-1);var p=(d-v)*(t.smoothSide?1:2);r+=p*f+(t.smoothBevel?0:c*p*2)}}for(var x={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},y={vertex:0,index:0},m=0;m<e.length;m++)ae(e[m],x,y,t);for(var b=0;b<e.length;b++){var _=e[b],w=_.holes,M=_.vertices.length/2,O=0,j=w&&w.length?w[0]:M;if(oe(x,e[b],O,j,y,t),w)for(var T=0;T<w.length;T++)O=w[T],j=w[T+1]||M,oe(x,e[b],O,j,y,t)}for(var C=0;C<x.uv.length;C++){var A=x.uv[C];0<A&&Math.round(A)===A?x.uv[C]=1:x.uv[C]=A%1}return x.normal=function(e,t){function n(e,t,n,r){e[0]=t,e[1]=n,e[2]=r}for(var r,i,o,a,s,h,u,l,c,f,v,d,g,p,x,y=[],m=[],b=[],_=[],w=[],M=[],O=e.length,j=new Float32Array(t.length),T=0;T<O;){var C=3*e[T++],A=3*e[T++],S=3*e[T++];n(y,t[C],t[1+C],t[2+C]),n(m,t[A],t[1+A],t[2+A]),n(b,t[S],t[1+S],t[2+S]),N(_,y,m),N(w,m,b),r=M,o=w,0,a=(i=_)[0],s=i[1],h=i[2],u=o[0],l=o[1],c=o[2],r[0]=s*c-h*l,r[1]=h*u-a*c,r[2]=a*l-s*u;for(var B=0;B<3;B++)j[C+B]=j[C+B]+M[B],j[A+B]=j[A+B]+M[B],j[S+B]=j[S+B]+M[B]}for(var I=0;I<j.length;)n(M,j[I],j[I+1],j[I+2]),0,d=(v=f=M)[0],g=v[1],p=v[2],x=Math.sqrt(d*d+g*g+p*p),f[0]=d/x,f[1]=g/x,f[2]=p/x,j[I++]=M[0],j[I++]=M[1],j[I++]=M[2];return j}(x.indices,x.position),x.boundingRect=e[0]&&e[0].rect,x}function he(e,t,n){for(var r=n.lineWidth,i=e.length,o=new Float32Array(2*i),a=n.translate||[0,0],s=n.scale||[1,1],h=0,u=0;h<i;h++)o[u++]=e[h][0]*s[0]+a[0],o[u++]=e[h][1]*s[1]+a[1];X(o,0,i)<0&&ne(o,2,0,i);var l=[],c=[],f=n.miterLimit,v=ee(o,c,0,i,0,-r/2,f,!1);ne(o,2,0,i);for(var d=ee(o,l,0,i,0,-r/2,f,!1),g=(l.length+c.length)/2,p=new Float32Array(2*g),x=0,y=c.length/2,m=0;m<c.length;m++)p[x++]=c[m];for(var b=0;b<l.length;b++)p[x++]=l[b];for(var _=new(65535<g?Uint32Array:Uint16Array)(3*(2*(i-1)+(g-2*i))),w=0,M=0;M<i-1;M++){var O=M+1;_[w++]=y-1-v[M],_[w++]=y-1-v[M]-1,_[w++]=d[M]+1+y,_[w++]=y-1-v[M],_[w++]=d[M]+1+y,_[w++]=d[M]+y,d[O]-d[M]==2?(_[w++]=d[M]+2+y,_[w++]=d[M]+1+y,_[w++]=y-v[O]-1):v[O]-v[M]==2&&(_[w++]=d[O]+y,_[w++]=y-1-(v[M]+1),_[w++]=y-1-(v[M]+2))}var j=0<n.bevelSize?te(p,[],n.bevelSize,null,!0):p,T=n.boundingRect;return{vertices:p,indices:_,topVertices:j,rect:{x:T.x*s[0]+a[0],y:T.y*s[1]+a[1],width:T.width*s[0],height:T.height*s[1]},depth:"function"==typeof n.depth?n.depth(t):n.depth,holes:[]}}function de(e,t){for(var n=[],r=0;r<e.length;r++){for(var i=e[r],o=[],a=i.length,s=i[a-1][0],h=i[a-1][1],u=0,l=0;l<a;l++){var c=i[l][0],f=i[l][1],v=c-s,d=f-h;t<(u+=Math.sqrt(v*v+d*d))&&(o.push(i[l]),u=0),s=c,h=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}function ge(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r];3<=(i=K(i,t,!0)).length&&n.push(i)}return 0<n.length?n:null}function pe(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)xe(e[i],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},ie(t);var o=t.scale||[1,1];null==t.lineWidth&&(t.lineWidth=1),null==t.miterLimit&&(t.miterLimit=2);for(var a=[],s=0;s<e.length;s++){var h=e[s],u=t.simplify/Math.max(o[0],o[1]);0<u&&(h=K(h,u,!0)),a.push(he(h,s,t))}return se(a,t)}function xe(e,t,n){for(var r=0;r<e.length;r++)t[0]=Math.min(e[r][0],t[0]),t[1]=Math.min(e[r][1],t[1]),n[0]=Math.max(e[r][0],n[0]),n[1]=Math.max(e[r][1],n[1])}var ye=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function me(e){return void 0===e&&(e={}),(e.geometry||{}).type}function be(e){void 0===e&&(e={});var t=me(e);if(t)for(var n=0,r=ye.length;n<r;n++)if(ye[n]===t)return 1}function _e(e){void 0===e&&(e={});var t=me(e);return!(!t||t!==ye[4]&&t!==ye[5])}function we(e){void 0===e&&(e={});var t=me(e);return!(!t||t!==ye[2]&&t!==ye[3])}function Me(e){void 0===e&&(e={});var t=me(e);return!(!t||t!==ye[0]&&t!==ye[1])}function Oe(e){return void 0===e&&(e={}),(e.geometry||{}).coordinates||[]}function je(e){void 0===e&&(e={});var t=me(e);if(!t)return null;var n=(e.geometry||{}).coordinates;if(!n)return null;var r=[];switch(t){case"Point":r.push(n);break;case"MultiPoint":case"LineString":for(var i=0,o=n.length;i<o;i++)r.push(n[i]);break;case"MultiLineString":case"Polygon":for(var a=0,s=n.length;a<s;a++)for(var h=0,u=n[a].length;h<u;h++)r.push(n[a][h]);break;case"MultiPolygon":for(var l=0,c=n.length;l<c;l++)for(var f=0,v=n[l].length;f<v;f++)for(var d=0,g=n[l][f].length;d<g;d++)r.push(n[l][f][d])}for(var p=1/0,x=1/0,y=-1/0,m=-1/0,b=0,_=r.length;b<_;b++){var w=r[b],M=w[0],O=w[1];p=Math.min(p,M),x=Math.min(x,O),y=Math.max(y,M),m=Math.max(m,O)}return new ue.Coordinate((p+y)/2,(x+m)/2)}function Te(e){void 0===e&&(e={});var t=me(e);if(!t)return null;var n=e.geometry||{},r=e.properties||{},i=n.coordinates;if(!i)return null;var o,a=[];switch(t){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon"}if(o)for(var s=0,h=i.length;s<h;s++)a.push({type:"Feature",geometry:{type:o,coordinates:i[s]},properties:r});else a.push(e);return a}var Ce=",";function Ae(e,t,n){var r=[],i=[];if(Array.isArray(e)&&e[0]instanceof le.Vector3)for(var o=0,a=e.length;o<a;o++){var s=e[o];r.push(s.x,s.y,s.z),i.push(s)}else{Array.isArray(e)&&(e=new ue.LineString(e));var h,u;u=be(e)?(h=Oe(e),je(e)):(h=e.getCoordinates(),e.getCenter());for(var l=t.coordinateToVector3(n||u),c=0,f=h.length;c<f;c++){var v=h[c];Array.isArray(v)&&(v=new ue.Coordinate(v));var d=t.coordinateToVector3(v,0).sub(l);r.push(d.x,d.y,d.z),i.push(d)}}return{positions:r,positionsV:i}}function Se(e,t,n,r){for(var i=[],o=[],a=[],s=0,h=e.length;s<h;s++)for(var u=e[s],l=0,c=u.length;l<c;l++){var f=u[l];if(0<a.length)f.join(Ce).toString()!==a[a.length-1].join(Ce).toString()&&a.push(f);else a.push(f)}for(var v=0,d=a.length;v<d;v++){var g=a[v],p=void 0,x=g.join(Ce).toString();p=n&&n[x]?n[x]:t.coordinateToVector3(g,0).sub(r),o.push(p),i.push(p.x,p.y,p.z)}return{positions:i,positionsV:o,lnglats:a}}function Be(e,t,n,r,i){void 0===t&&(t=1),void 0===n&&(n=1);for(var o=Ae(e,r,i).positionsV,a=[],s=0,h=o.length;s<h;s++){var u=o[s];a.push([u.x,u.y])}var l=pe([a],{lineWidth:t,depth:n}),c=l.indices;return{position:l.position,normal:l.normal,indices:c}}var Ie={altitude:0,colors:null},Ve=function(d){function e(e,t,n,r){var i;t=ue.Util.extend({},Ie,t,{layer:r,lineString:e}),(i=d.call(this)||this)._initOptions(t);var o=Ae(e,r).positions,a=new le.BufferGeometry;ce(a,"position",new le.Float32BufferAttribute(o,3));var s,h,u=(s=t.colors,h=[],s&&s.length&&s.forEach(function(e){e=e instanceof le.Color?e:new le.Color(e),h.push(e.r,e.g,e.b)}),h);u&&u.length&&(ce(a,"color",new le.Float32BufferAttribute(u,3)),n.vertexColors=le.VertexColors),i._createLine(a,n);var l=t.altitude,c=be(e)?je(e):e.getCenter(),f=r.distanceToVector3(l,l).x,v=r.coordinateToVector3(c,f);return i.getObject3d().position.copy(v),i}return i(e,d),e}(l),ze={width:3,height:1,altitude:0},ke=function(f){function e(e,t,n,r){var i;t=ue.Util.extend({},ze,t,{layer:r,lineString:e}),(i=f.call(this)||this)._initOptions(t);var o=t.height,a=t.width;t.height=r.distanceToVector3(o,o).x,t.width=r.distanceToVector3(a,a).x;var s=function(e,t,n,r,i){void 0===t&&(t=1),void 0===n&&(n=1);for(var o=Ae(e,r,i).positionsV,a=[],s=0,h=o.length;s<h;s++){var u=o[s];a.push([u.x,u.y])}var l=pe([a],{lineWidth:t,depth:n}),c=l.indices,f=l.position,v=l.normal,d=new le.BufferGeometry;return ce(d,"position",new le.Float32BufferAttribute(f,3)),ce(d,"normal",new le.Float32BufferAttribute(v,3)),d.setIndex(new le.Uint32BufferAttribute(c,1)),d}(e,t.width,t.height,r);i._createMesh(s,n);var h=t.altitude,u=be(e)?je(e):e.getCenter(),l=r.distanceToVector3(h,h).x,c=r.coordinateToVector3(u,l);return i.getObject3d().position.copy(c),i}return i(e,f),e}(l);function Le(e,t,n,r){var i=Ue(e,n,r);if(!i)return null;var o=function(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)xe(e[i][0],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},ie(t);for(var o,a=[],s=t.translate||[0,0],h=t.scale||[1,1],u=t.boundingRect,l={x:u.x*h[0]+s[0],y:u.y*h[1]+s[1],width:u.width*h[0],height:u.height*h[1]},c=Math.min(u.width,u.height)/1e5,f=0;f<e.length;f++){var v=de(e[f],c);if(v){var d=t.simplify/Math.max(h[0],h[1]);if(0<d&&(v=ge(v,d)),v){for(var g=M.flatten(v),p=g.vertices,x=g.holes,y=g.dimensions,m=0;m<p.length;)p[m]=p[m++]*h[0]+s[0],p[m]=p[m++]*h[1]+s[1];if(re(p,x),2!==y)throw new Error("Only 2D polygon points are supported");var b=0<t.bevelSize?te(p,x,t.bevelSize,null,!0):p,_=(void 0===(o=y)&&(o=2),M(b,x,o));a.push({indices:_,vertices:p,topVertices:b,holes:x,rect:l,depth:"function"==typeof t.depth?t.depth(f):t.depth})}}}return se(a,t)}(i,{depth:t=n.distanceToVector3(t,t).x});return{position:o.position,normal:o.normal,uv:o.uv,indices:o.indices}}function Pe(e,t,n){for(var r=e.attributes.position.array,i=r.length,o=t instanceof le.Color?t:new le.Color(t),a=new le.Color(n),s=[],h=0;h<i;h+=3){0<r[h+2]?s.push(a.r,a.r,a.b):s.push(o.r,o.r,o.b)}return ce(e,"color",new le.Float32BufferAttribute(s,3,!0)),s}function Ee(e){void 0===e&&(e=[]);for(var t=1/0,n=1/0,r=-1/0,i=-1/0,o=0,a=e.length;o<a;o++){var s=e[o],h=void 0,u=void 0;Array.isArray(s)?(h=s[0],u=s[1]):s instanceof ue.Coordinate&&(h=s.x,u=s.y),t=Math.min(t,h),n=Math.min(n,u),r=Math.max(r,h),i=Math.max(i,u)}return new ue.Coordinate((t+r)/2,(n+i)/2)}function Ue(t,n,r,i){if(void 0===i&&(i=!1),!t)return null;var e=[];if(t instanceof ue.MultiPolygon)e=t.getGeometries().map(function(e){return Ze(e,n,r||t.getCenter(),i)});else if(t instanceof ue.Polygon){var o=Ze(t,n,r||t.getCenter(),i);e.push(o)}else if(_e(t)){var a=je(t);if(function(e){void 0===e&&(e={});var t=me(e);return!!(t&&-1<t.indexOf("Multi"))}(t))for(var s=Te(t),h=0,u=s.length;h<u;h++)e.push(Ze(s[h],n,r||a,i));else{var l=Ze(t,n,r||a,i);e.push(l)}}return e}function Ze(e,t,n,r){var i,o;if(void 0===r&&(r=!1),_e(e)){var a=Oe(e);i=a[0],o=a.slice(1,a.length),n=n||je(e)}else i=e.getShell(),o=e.getHoles(),n=n||e.getCenter();var s,h=t.coordinateToVector3(n);s=r?new Float32Array(2*i.length):[];for(var u=0,l=i.length;u<l;u++){var c=i[u],f=t.coordinateToVector3(c).sub(h);if(r){var v=2*u;s[v]=f.x,s[1+v]=f.y}else s.push([f.x,f.y])}var d=[r?s.buffer:s];if(o&&0<o.length)for(var g=0,p=o.length;g<p;g++){for(var x=r?new Float32Array(2*o[g].length):[],y=0,m=o[g].length;y<m;y++){var b=o[g][y],_=t.coordinateToVector3(b).sub(h);if(r){var w=2*y;x[w]=_.x,x[1+w]=_.y}else x.push([_.x,_.y])}d.push(r?x.buffer:x)}return d}var Re={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},Fe=function(v){function e(e,t,n,r){var i;t=ue.Util.extend({},Re,t,{layer:r,polygon:e}),(i=v.call(this)||this)._initOptions(t);var o=t.height,a=t.topColor,s=t.bottomColor,h=t.altitude,u=function(e,t,n,r){var i=Le(e,t,n,r),o=i.position,a=i.normal,s=i.uv,h=i.indices,u=new Float32Array(o.length);u.fill(1,0,o.length);var l=new le.BufferGeometry;return ce(l,"color",new le.BufferAttribute(u,3)),ce(l,"normal",new le.BufferAttribute(a,3)),ce(l,"position",new le.BufferAttribute(o,3)),ce(l,"uv",new le.BufferAttribute(s,2)),l.setIndex(new le.Uint32BufferAttribute(h,1)),l}(e,o,r),l=_e(e)?je(e):e.getCenter();a&&!n.map&&(Pe(u,s,a),n.vertexColors=le.VertexColors),i._createMesh(u,n);var c=r.distanceToVector3(h,h).x,f=r.coordinateToVector3(l,c);return i.getObject3d().position.copy(f),i}return i(e,v),e}(l),Ge={altitude:0,coordinate:null},De=function(h){function e(e,t,n){var r;void 0===t&&(t={}),t.coordinate||(console.warn("coordinate is null,it is important to locate the model"),t.coordinate=n.getMap().getCenter()),t=ue.Util.extend({},Ge,t,{layer:n,model:e}),(r=h.call(this)||this)._initOptions(t),r._createGroup(),r.getObject3d().add(e);var i=t.altitude,o=t.coordinate,a=n.distanceToVector3(i,i).x,s=n.coordinateToVector3(o,a);return r.getObject3d().position.copy(s),r}return i(e,h),e}(l),We=Math.PI/180,Ke=6378137,qe=1;function He(e){return e*We}function Ne(e,t){if(!e||!t)return 0;Array.isArray(e)||(e=e.toArray()),Array.isArray(t)||(t=t.toArray());var n=He(e[1]),r=He(t[1]),i=n-r,o=He(e[0])-He(t[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(n)*Math.cos(r)*Math.pow(Math.sin(o/2),2))),n*=Ke,Math.round(1e5*n)/1e5}function Qe(e,t){void 0===t&&(t=10),t=Math.max(t,qe),Array.isArray(e)||(e=e.getCoordinates().map(function(e){return e.toArray()}));for(var n=e.length,r=[],i=0,o=0;o<n-1;o++){var a=Ne(e[o],e[o+1]),s=Math.floor(a);r.push({c1:e[o],len:s,c2:e[o+1]}),i+=s}if(i<=t)return r.map(function(e){return[e.c1,e.c2]});if(1===r.length&&r[0].len<=t)return[[r[0].c1,r[0].c2]];for(var h,u,l,c,f,v,d,g,p,x=r.length,y=0,m=0,b=[],_=[r[0].c1];y<x;){var w=r[y],M=w.len,O=w.c2;if((m+=M)<t&&(_.push(O),y===x-1&&b.push(_),y++),m===t&&(_.push(O),m=0,b.push(_),_=[O],y++),t<m){var j=M-m+t;u=r[y],l=j,0,c=u.len,f=u.c1,v=u.c2,d=v[0]-f[0],g=v[1]-f[1],p=l/c,h=[f[0]+p*d,f[1]+p*g],_.push(h),b.push(_),m=0,r[y].c1=h,r[y].len=M-j,(_=[]).push(h)}}return b}function Xe(e,t,n,r){var i=t.length;e.attributes.normal.count=i,e.attributes.position.count=i;for(var o=e.attributes.position.array,a=e.attributes.normal.array,s=0;s<i;s++)o[s]=t[s],a[s]=n[s];e.index.count=r.length;for(var h=0,u=r.length;h<u;h++)e.index.array[h]=r[h]}function Ye(e){return function(e){function t(){return e.apply(this,arguments)||this}i(t,e);var n=t.prototype;return n._initBaseObjectsEvent=function(e){if(e&&Array.isArray(e)&&e.length)for(var t=0,n=e.length;t<n;t++){var r=e[t];this._proxyEvent(r)}return this},n._proxyEvent=function(e){var t=this;e.on("add",function(e){t._showGeometry(e.target,!0)}),e.on("remove",function(e){t._showGeometry(e.target,!1)}),e.on("mouseout",function(e){t._mouseover=!1,t.fire("mouseout",Object.assign({},e,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}))}),e.on(nt,function(e){t.fire(e.type,Object.assign({},e,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}))})},n._getHideGeometryIndex=function(e){for(var t=[],n=0,r=0,i=this._geometriesAttributes.length;r<i;r++)!0===this._geometriesAttributes[r].hide&&(t.push(r),n+=this._geometriesAttributes[r][e].count);return{indexs:t,count:n}},n._updateAttribute=function(e,t){for(var n=this._getHideGeometryIndex(t).indexs,r=this._geometryCache.attributes[t].array,i=r.length,o=0;o<i;o++)e.array[o]=r[o];var a=NaN;this.getObject3d()instanceof le.LineSegments&&(a=0);for(var s=0;s<n.length;s++)for(var h=n[s],u=this._geometriesAttributes[h][t],l=u.start,c=u.end,f=l;f<c;f++)e.array[f]=a;return this},n._showGeometry=function(e,t){var n;if(e&&(n=e.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===t)return this;r.hide=t;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.position,"position"),i.attributes.position.needsUpdate=!0,this.isHide=t}return this},n.getSelectMesh=function(){return{data:null,baseObject:null}},t}(e)}var Je,$e,et={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1},tt=function(V){function e(e,t,n,r){var i;t=ue.Util.extend({},et,t,{layer:r,lineString:e}),(i=V.call(this)||this)._initOptions(t);for(var o,a=t.width,s=t.height,h=t.altitude,u=t.speed,l=t.chunkLength,c=t.trail,f=Qe(be(e)?(o=je(e),Oe(e)):(o=e.getCenter(),e),l),v=r.coordinateToVector3(e.getCenter()),d={},g=0,p=f.length;g<p;g++)for(var x=f[g],y=0,m=x.length;y<m;y++){var b=x[y],_=b.join(",").toString();d[_]||(d[_]=r.coordinateToVector3(b).sub(v))}var w=Se(f.slice(0,1),r,d,v).positionsV,M=new le.BufferGeometry,O=new Float32Array(3e3),j=new Float32Array(3e3),T=new Uint16Array(1e3);ce(M,"position",new le.BufferAttribute(O,3)),ce(M,"normal",new le.BufferAttribute(j,3)),M.setIndex(new le.BufferAttribute(T,1));var C=r.distanceToVector3(a,a).x,A=r.distanceToVector3(s,s).x,S=Be(w,C,A,r);Xe(M,S.position,S.normal,S.indices),i._createMesh(M,n);var B=r.distanceToVector3(h,h).x,I=r.coordinateToVector3(o,B);return i.getObject3d().position.copy(I),i._params={index:0,chunkLines:f,geometries:[],layer:r,trail:Math.max(1,c),lineWidth:C,depth:A,speed:Math.min(1,u),idx:0,loaded:!1,positionMap:d,centerPt:v},i._init(i._params),i}i(e,V);var t=e.prototype;return t._init=function(e){for(var t=e.layer,n=e.trail,r=e.lineWidth,i=e.depth,o=e.chunkLines,a=e.positionMap,s=e.centerPt,h=o.length,u=[],l=0;l<h;l++){var c=Se(o.slice(l,l+n),t,a,s).positionsV;u.push(Be(c,r,i,t))}this._params.geometries=u,this._params.loaded=!0},t._animation=function(){var e=this._params,t=e.index,n=e.geometries,r=e.speed,i=e.idx,o=e.chunkLines,a=e.trail,s=e.lineWidth,h=e.depth,u=e.loaded,l=e.layer,c=e.positionMap,f=e.centerPt;if(u){var v=Math.round(t);if(i<v){this._params.idx++;var d=n[v];if(!d)d=Be(Se(o.slice(v,v+a),l,c,f).positionsV,s,h,l),n[v]=d;Xe(this.getObject3d().geometry,d.position,d.normal,d.indices),this.getObject3d().geometry.attributes.position.needsUpdate=!0,this.getObject3d().geometry.attributes.normal.needsUpdate=!0,this.getObject3d().geometry.index.needsUpdate=!0}t>=o.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=r}},e}(l),nt=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),rt={name:"maptalks.three",version:"0.10.1",description:"A maptalks Layer to render with THREE.js.",license:"MIT",repository:{type:"git",url:"https://github.com/maptalks/maptalks.three.js.git"},files:["dist/maptalks.three.js","dist/maptalks.three.min.js","dist/maptalks.three.es.js","dist/maptalks.three.js.map"],main:"dist/maptalks.three.js",module:"dist/maptalks.three.es.js","jsnext:main":"dist/maptalks.three.es.js",scripts:{dev:"rollup -w -c rollup.config.js",build:"rollup --environment BUILD:production -c rollup.config.js","build-dev":"rollup -c rollup.config.js",preversion:"npm run lint",version:"npm run build && git add -A dist",lint:"eslint index.js src/**/*.js test/**/*.js",prepublish:"npm run lint && npm run build"},devDependencies:{"@babel/core":"^7.0.0","@babel/preset-env":"^7.0.0","babel-eslint":"^9.0.0",eslint:"^4.19.1","eslint-config-maptalks":"^0.3.0","eslint-plugin-mocha":"^5.0.0",rollup:"^0.66.1","rollup-plugin-babel":"^4.1.0-0","rollup-plugin-commonjs":"^9.1.0","rollup-plugin-json":"^4.0.0","rollup-plugin-node-resolve":"^3.3.0","rollup-plugin-uglify":"^6.0.0",three:"^0.97.0"},peerDependencies:{maptalks:">=0.39.0"},dependencies:{"geometry-extrude":"^0.1.2"}};ue.worker&&(Je=function(e){function t(){return e.apply(this,arguments)||this}i(t,e);var n=t.prototype;return n.test=function(e,t){this.send(e,null,t)},n.pushQueue=function(e){void 0===e&&(e={});var t,n=e.type,r=e.data,i=e.callback,o=e.layer,a=e.key,s=e.center;"Polygon"===n&&(t=function(e,t,n){void 0===e&&(e=[]);for(var r=e.length,i=[],o=[],a=0;a<r;a++){for(var s=e[a],h=Ue(s,n,t,!0),u=0,l=h.length;u<l;u++)for(var c=h[u],f=0,v=c.length;f<v;f++)o.push(c[f]);var d=(_e(s)?s.properties:s.getProperties()||{}).height||1;d=n.distanceToVector3(d,d).x,i.push({data:h,height:d})}return{datas:i,transfer:o}}(r,s,o)),this.send({type:n,datas:t.datas},t.transfe,function(e,t){e&&console.error(e),t.key=a,i(t)})},t}(ue.worker.Actor));var it={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},ot=function(P){function e(e,t,i,n){var o;Array.isArray(e)||(e=[e]);for(var r=[],a=e.length,s=0;s<a;s++){var h=e[s];r.push(_e(h)?je(h):h.getCenter())}var u,l=Ee(r),c=(t=ue.Util.extend({},it,t,{layer:n,polygons:e,coordinate:l}),t.topColor),f=t.bottomColor,v=t.altitude,d=[],g=[],p=[];if(t.asynchronous){var x=(ue.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),$e=$e||new Je(rt.name));u=new le.BoxBufferGeometry(1e-6,1e-6,1e-6*5),x.pushQueue({type:"Polygon",layer:n,key:t.key,center:l,data:e,callback:function(e){var t=e.faceMap,n=e.geometriesAttributes;o._faceMap=t,o._geometriesAttributes=n;var r=function(e){var t=e.position,n=e.normal,r=e.uv,i=e.indices,o=new Float32Array(t.length);o.fill(1,0,t.length);var a=new le.BufferGeometry;return ce(a,"color",new le.BufferAttribute(o,3)),ce(a,"normal",new le.BufferAttribute(new Float32Array(n),3)),ce(a,"position",new le.BufferAttribute(new Float32Array(t),3)),ce(a,"uv",new le.BufferAttribute(new Float32Array(r),2)),a.setIndex(new le.BufferAttribute(new Uint32Array(i),1)),a}(e);c&&!i.map&&(Pe(r,f,c),i.vertexColors=le.VertexColors),o.getObject3d().geometry.dispose(),o.getObject3d().geometry=r,o.getObject3d().material.needsUpdate=!0,o._geometryCache=r.clone(),o._fire("workerload",{target:function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(o)})}})}else{for(var y=[],m=0,b=0,_=0,w=0,M=0;M<a;M++){var O=e[M],j=(_e(O)?O.properties:O.getProperties()||{}).height||1,T=Le(O,j,n,l);y.push(T);var C=T.position,A=T.normal,S=T.uv,B=T.indices.length/3;g[M]=[m+1,m+B],m+=B;var I=C.length/3,V=A.length/3,z=S.length/2;p[M]={position:{count:I,start:b,end:b+3*I},normal:{count:V,start:_,end:_+3*V},uv:{count:z,start:w,end:w+2*z},hide:!1},b+=3*I,_+=3*V,w+=2*z}u=Z(y),c&&!i.map&&(Pe(u,f,c),i.vertexColors=le.VertexColors)}(o=P.call(this)||this)._initOptions(t),o._createMesh(u,i);var k=n.distanceToVector3(v,v).x,L=n.coordinateToVector3(l,k);return o.getObject3d().position.copy(L),o._faceMap=g,o._baseObjects=d,o._datas=e,o._geometriesAttributes=p,o.faceIndex=null,o._geometryCache=u.clone(),o.isHide=!1,o._initBaseObjectsEvent(d),o}i(e,P);var t=e.prototype;return t.getSelectMesh=function(){var e=this._getIndex();if(null!=e){if(!this._baseObjects[e]){var t=this._datas[e],n=Object.assign({},this.options,_e(t)?t.properties:t.getProperties(),{index:e});this._baseObjects[e]=new Fe(t,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[e])}return{data:this._datas[e],baseObject:this._baseObjects[e]}}},t._getIndex=function(e){if(null==e&&(e=this.faceIndex),null!=e)for(var t=0,n=this._faceMap.length;t<n;t++){var r=this._faceMap[t],i=r[0],o=r[1];if(i<=e&&e<o)return t}},e}(Ye(l));function at(e,t,n){var r=e.project(n),i=t.width/2,o=t.height/2;return{x:Math.round(r.x*i+i),y:Math.round(-r.y*o+o)}}var st={altitude:0,height:0},ht=new le.Vector3,ut=function(g){function e(e,t,n,r){var i;t=ue.Util.extend({},st,t,{layer:r,coordinate:e}),i=g.call(this)||this;var o=t.height,a=t.altitude,s=t.color,h=[],u=[];s&&(s=s instanceof le.Color?s:new le.Color(s),u.push(s.r,s.g,s.b));var l=r.distanceToVector3(o,o).x,c=r.coordinateToVector3(e,l);h.push(0,0,c.z);var f=new le.BufferGeometry;ce(f,"position",new le.Float32BufferAttribute(h,3,!0)),u.length&&ce(f,"color",new le.Float32BufferAttribute(u,3,!0)),t.positions=c,i._initOptions(t),i._createPoints(f,n);var v=r.distanceToVector3(a,a).x,d=new le.Vector3(c.x,c.y,v);return i.getObject3d().position.copy(d),i}return i(e,g),e.prototype.identify=function(e){var t=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().positions,o=this.getOptions().altitude,a=this.getObject3d().material.size,s=this.getMap().coordToContainerPoint(e),h=t.distanceToVector3(o,o).x;ht.x=i.x,ht.y=i.y,ht.z=i.z+h;var u=at(ht,n,r);return Math.sqrt(Math.pow(s.x-u.x,2)+Math.pow(s.y-u.y,2))<=a/2},e}(l);function lt(e,t){var n=e.minx,r=e.miny,i=e.maxx,o=e.maxy,a=t[0],s=t[1];return n<=a&&a<=i&&r<=s&&s<=o}var ct=function(){function f(e,t,n,r){this.minlng=e,this.minlat=t,this.maxlng=n,this.maxlat=r,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}var e=f.prototype;return e.updateBBoxPixel=function(t){var n=1/0,r=1/0,i=-1/0,o=-1/0,e=this.minlng,a=this.minlat,s=this.maxlng,h=this.maxlat;return[[e,a],[e,h],[s,a],[s,h]].map(function(e){return new ue.Coordinate(e)}).map(function(e){return t.coordToContainerPoint(e)}).forEach(function(e){n=Math.min(n,e.x),r=Math.min(r,e.y),i=Math.max(i,e.x),o=Math.max(o,e.y)}),this.minx=n,this.miny=r,this.maxx=i,this.maxy=o,this},e.containsCoordinate=function(e){var t,n;Array.isArray(e)?(t=e[0],n=e[1]):e instanceof ue.Coordinate&&(t=e.x,n=e.y);var r=this.minlng,i=this.minlat,o=this.maxlng,a=this.maxlat;return!!(r<=t&&t<=o&&i<=n&n<=a)},e.isRecCross=function(e,t){var n=e.x,r=e.y,i={minx:n-t/2,miny:r-t/2,maxx:n+t/2,maxy:r+t/2},o=i.minx,a=i.miny,s=i.maxx,h=i.maxy;return!!(lt(this,[o,a])||lt(this,[o,h])||lt(this,[s,a])||lt(this,[s,h])||lt(i,[this.minx,this.miny])||lt(i,[this.minx,this.maxy])||lt(i,this.maxx,this.miny)||lt(i,this.maxx,this.maxy))},f.initGrids=function(e,t,n,r){for(var i=[],o=(n-e)/30,a=(r-t)/30,s=e,h=t,u=0;u<30;u++){s=e+u*o;for(var l=0;l<30;l++){var c=new f(s,h=t+l*a,s+o,h+a);c.key=l+"-"+u,i.push(c)}}return i},f}(),ft={altitude:0},vt=new le.Vector3,dt=function(P){function e(e,t,n,r){var i;Array.isArray(e)||(e=[e]),t=ue.Util.extend({},ft,t,{layer:r,points:e});for(var o=1/0,a=1/0,s=-1/0,h=-1/0,u=0,l=e.length;u<l;u++){var c=e[u].coordinate,f=void 0,v=void 0;Array.isArray(c)?(f=c[0],v=c[1]):c instanceof ue.Coordinate&&(f=c.x,v=c.y),o=Math.min(o,f),a=Math.min(a,v),s=Math.max(s,f),h=Math.max(h,v)}for(var d=r.coordinateToVector3([(o+s)/2,(a+h)/2]),g=ct.initGrids(o,a,s,h),p=g.length,x=[],y=[],m=[],b=[],_=[],w=0,M=e.length;w<M;w++){var O=e[w],j=O.coordinate,T=O.height,C=O.color;C&&(C=C instanceof le.Color?C:new le.Color(C),m.push(C.r,C.g,C.b));var A=r.distanceToVector3(T,T).x,S=r.coordinateToVector3(j,A),B=S.clone().sub(d);x.push(B.x,B.y,B.z),y.push(S),_[w]={position:{count:1,start:3*w,end:3*w+3},hide:!1};for(var I=0;I<p;I++)if(g[I].containsCoordinate(j)){g[I].positions.push(S),g[I].indexs.push(w);break}}var V=new le.BufferGeometry;ce(V,"position",new le.Float32BufferAttribute(x,3,!0)),m.length&&ce(V,"color",new le.Float32BufferAttribute(m,3,!0)),t.positions=y,(i=P.call(this)||this)._initOptions(t),i._createPoints(V,n);var z=t.altitude,k=r.distanceToVector3(z,z).x,L=d.clone();return L.z=k,i.getObject3d().position.copy(L),i._baseObjects=b,i._datas=e,i.faceIndex=null,i._geometriesAttributes=_,i._geometryCache=V.clone(),i.isHide=!1,i._initBaseObjectsEvent(b),i._grids=g,i._bindMapEvents(),i}i(e,P);var t=e.prototype;return t._bindMapEvents=function(){var e=this,t=this.getMap();this.on("add",function(){e._updateGrids(),t.on("zoomstart zooming zoomend movestart moving moveend pitch rotate",e._updateGrids,e)}),this.on("remove",function(){t.off("zoomstart zooming zoomend movestart moving moveend pitch rotate",e._updateGrids,e)})},t._updateGrids=function(){var t=this.getMap();this._grids.forEach(function(e){e.indexs.length&&e.updateBBoxPixel(t)})},t.getSelectMesh=function(){var e=this.faceIndex;if(null!=e){if(!this._baseObjects[e]){var t=this._datas[e],n=t.coordinate,r=t.height,i=t.color;this._baseObjects[e]=new ut(n,{height:r,index:e,color:i},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[e])}return{data:this._datas[e],baseObject:this._baseObjects[e]}}},t.identify=function(e){var t=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().altitude,o=this.getMap(),a=t.distanceToVector3(i,i).x,s=this.getObject3d().material.size,h=o.coordToContainerPoint(e),u=[];if(this._grids.forEach(function(e){e.indexs.length&&e.isRecCross(h,s)&&u.push(e)}),u.length<1)return!1;for(var l=0,c=u.length;l<c;l++)for(var f=0,v=u[l].positions.length;f<v;f++){var d=u[l].positions[f];vt.x=d.x,vt.y=d.y,vt.z=d.z+a;var g=at(vt,n,r);if(Math.sqrt(Math.pow(h.x-g.x,2)+Math.pow(h.y-g.y,2))<=s/2)return this.faceIndex=u[l].indexs[f],!0}return!1},e}(Ye(l)),gt={coordinate:null,radius:10,height:100,radialSegments:6,altitude:0,topColor:null,bottomColor:"#2d2f61"},pt=function(U){function e(e,t,n,r){var i;Array.isArray(e)||(e=[e]);for(var o=e.length,a=[],s=[],h=[],u=[],l=0,c=0,f=0,v=0,d=0;d<o;d++){var g=ue.Util.extend({index:d},gt,e[d]),p=g.radius,x=g.radialSegments,y=g.altitude,m=g.topColor,b=g.bottomColor,_=g.height,w=g.coordinate,M=r.distanceToVector3(p,p).x,O=r.distanceToVector3(_,_).x,j=r.distanceToVector3(y,y).x,T=R({radius:M,height:O,radialSegments:x},!1);m&&!n.map&&(F(T,b,m,"z",O/2),n.vertexColors=le.VertexColors);for(var C=r.coordinateToVector3(w),A=T.attributes.position.array,S=0,B=A.length;S<B;S+=3)A[S+2]+=j,A[S]+=C.x,A[S+1]+=C.y,A[S+2]+=C.z;a.push(T);var I=new G(w,g,n,r);s.push(I);var V=new le.Geometry;V.fromBufferGeometry(T);var z=V.faces.length;u[d]=[l+1,l+z],l+=z,V.dispose();var k=T.attributes.position.count,L=T.attributes.normal.count,P=T.attributes.uv.count;h[d]={position:{count:k,start:c,end:c+3*k},normal:{count:L,start:f,end:f+3*L},uv:{count:P,start:v,end:v+2*P},hide:!1},c+=3*k,f+=3*L,v+=2*P}i=U.call(this)||this,t=ue.Util.extend({},{altitude:0,layer:r,points:e},t),i._initOptions(t);var E=function(e){for(var t=[],n=[],r=0,i=e.length;r<i;r++){for(var o=e[r].attributes,a=o.color,s=o.normal,h=o.position,u=o.uv,l=e[r].index,c=0,f=a.array.length;c<f;c++)n.push(a.array[c]);t.push({normal:s.array,uv:u.array,position:h.array,indices:l.array})}for(var v=Z(t),d=0,g=n.length;d<g;d++)v.attributes.color.array[d]=n[d];return v}(a);return i._createMesh(E,n),i._faceMap=u,i._baseObjects=s,i._datas=e,i._geometriesAttributes=h,i.faceIndex=null,i._geometryCache=E.clone(),i.isHide=!1,i._initBaseObjectsEvent(s),i}i(e,U);var t=e.prototype;return t.getSelectMesh=function(){var e=this._getIndex();if(null!=e)return{data:this._datas[e],baseObject:this._baseObjects[e]}},t._getIndex=function(e){if(null==e&&(e=this.faceIndex),null!=e)for(var t=0,n=this._faceMap.length;t<n;t++){var r=this._faceMap[t],i=r[0],o=r[1];if(i<=e&&e<o)return t}},e}(Ye(l)),xt={width:3,height:1,altitude:0},yt=function(z){function e(e,t,n,r){var i;Array.isArray(e)||(e=[e]);for(var o=[],a=e.length,s=0;s<a;s++){var h=e[s];o.push(be(h)?je(h):h.getCenter())}for(var u=Ee(o),l=[],c=[],f=0,v=[],d=[],g=0,p=0,x=0;x<a;x++){var y=e[x],m=ue.Util.extend({},xt,be(y)?y.properties:y.getProperties(),{index:x}),b=m.height,_=m.width,w=Be(y,r.distanceToVector3(_,_).x,r.distanceToVector3(b,b).x,r,u);l.push(w);var M=new ke(y,m,n,r);c.push(M);var O=w.position,j=w.normal,T=w.indices.length/3;v[x]=[f+1,f+T],f+=T;var C=O.length/3,A=j.length/3;d[x]={position:{count:C,start:g,end:g+3*C},normal:{count:A,start:p,end:p+3*A},hide:!1},g+=3*C,p+=3*A}var S=Z(l);t=ue.Util.extend({},xt,t,{layer:r,lineStrings:e,coordinate:u}),(i=z.call(this)||this)._initOptions(t),i._createMesh(S,n);var B=t.altitude,I=r.distanceToVector3(B,B).x,V=r.coordinateToVector3(u,I);return i.getObject3d().position.copy(V),i._faceMap=v,i._baseObjects=c,i._datas=e,i._geometriesAttributes=d,i.faceIndex=null,i._geometryCache=S.clone(),i.isHide=!1,i._initBaseObjectsEvent(c),i}i(e,z);var t=e.prototype;return t.getSelectMesh=function(){var e=this._getIndex();if(null!=e)return{data:this._datas[e],baseObject:this._baseObjects[e]}},t._getIndex=function(e){if(null==e&&(e=this.faceIndex),null!=e)for(var t=0,n=this._faceMap.length;t<n;t++){var r=this._faceMap[t],i=r[0],o=r[1];if(i<=e&&e<o)return t}},e}(Ye(l)),mt={altitude:0,colors:null},bt=function(C){function e(e,t,n,r){var i;Array.isArray(e)||(e=[e]);for(var o=[],a=e.length,s=0;s<a;s++){var h=e[s];o.push(we(h)?je(h):h.getCenter())}var u=Ee(o);t=ue.Util.extend({},mt,t,{layer:r,lineStrings:e,coordinate:u});for(var l=[],c=0,f=[],v=[],d=0,g=[],p=0;p<a;p++){for(var x=Ae(e[p],r,u).positionsV,y=0,m=x.length;y<m;y++){var b=x[y];0<y&&y<m-1&&g.push(b.x,b.y,b.z),g.push(b.x,b.y,b.z)}var _=x.length+x.length-2,w=_;f[p]=[c,c+w],c+=w,v[p]={position:{count:_,start:d,end:d+3*_},hide:!1},d+=3*_}var M=new le.BufferGeometry;ce(M,"position",new le.Float32BufferAttribute(g,3)),(i=C.call(this)||this)._initOptions(t),i._createLineSegments(M,n);var O=t.altitude,j=r.distanceToVector3(O,O).x,T=r.coordinateToVector3(u,j);return i.getObject3d().position.copy(T),i._faceMap=f,i._baseObjects=l,i._datas=e,i._geometriesAttributes=v,i.faceIndex=null,i.index=null,i._geometryCache=M.clone(),i.isHide=!1,i._initBaseObjectsEvent(l),i}i(e,C);var t=e.prototype;return t.getSelectMesh=function(){var e=this._getIndex();if(null!=e){if(!this._baseObjects[e]){var t=this._datas[e],n=ue.Util.extend({},this.getOptions(),{index:e},we(t)?t.properties:t.getProperties());this._baseObjects[e]=new Ve(t,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[e])}return{data:this._datas[e],baseObject:this._baseObjects[e]}}},t._getIndex=function(e){if(null==e&&(e=this.faceIndex||this.index),null!=e)for(var t=0,n=this._faceMap.length;t<n;t++){var r=this._faceMap[t],i=r[0],o=r[1];if(i<=e&&e<o)return t}},e}(Ye(l)),_t=[],wt=[];function Mt(e,t){for(var n=0,r=e.length;n<r;n++){var i=e[n];if(i){var o=i.key,a=i.callback;if(t===o)return e.splice(n,1),a}}return null}var Ot=document.createElement("canvas");function jt(e,t){var n=Ot.getContext("2d");if(n.clearRect(0,0,256,256),n.save(),t){n.fillStyle="red",n.strokeStyle="rgba(255,0,0,0.4)",n.lineWidth=.2;var r=e||"tile";n.font="18px sans-serif",n.rect(0,0,256,256),n.stroke(),n.fillText(r,15,128)}return Ot.toDataURL()}function Tt(e,t){var n;return void 0===e&&(e=1),void 0===t&&(t=1),"undefined"==typeof document||(n=document.createElement("canvas"),e&&(n.width=e),t&&(n.height=t)),n}Ot.width=Ot.height=256;var Ct=function(r){function e(e,t){var n;return void 0===t&&(t={}),(n=r.call(this,ue.Util.GUID(),ue.Util.extend({urlTemplate:e},t))||this)._opts=null,n._layer=null,n.material=null,n.getMaterial=null,n._baseObjectKeys={},n._loadTiles={},n._add=null,n._layerLaodTime=(new Date).getTime(),n}i(e,r);var t=e.prototype;return t.isAsynchronous=function(){return this._opts.worker},t.getBaseObjects=function(){var e=this._loadTiles,t=[];for(var n in e){var r=this._baseObjectKeys[n];if(r&&Array.isArray(r)&&r.length)for(var i=0,o=r.length;i<o;i++)t.push(r[i])}return t},t.onSelectMesh=function(){},t.formatBaseObjects=function(){},t.loopMessage=function(){},t.getTileData=function(e){var n=e.key,t=e.url,r=e.callback,i=e.img;ue.Ajax.getJSON(t,{},function(e,t){e?(console.error(e),r(n,null,i)):r(n,t,i)})},t._getCurentTileKeys=function(){for(var e=this.getTiles().tileGrids||[],t=[],n={},r=0,i=e.length;r<i;r++)for(var o=e[r].tiles||[],a=0,s=o.length;a<s;a++){var h=o[a].dupKey;t.push(h),n[h]=!0}return{keys:t,keysMap:n}},t._isLoad=function(){var e=this._getCurentTileKeys().keys,t=Object.keys(this._renderer.tilesInView);return e.length===t.length},t._layerOnLoad=function(){var e=(new Date).getTime();if(!(e-this._layerLaodTime<20)){this._layerLaodTime=e;var t=this._renderer.tilesInView,n=this._loadTiles,r=this._layer,i=this._baseObjectKeys,o=Object.keys(t).length,a=Object.keys(n).length,s=[];if(o&&a)for(var h in n)t[h]||i[h]&&(i[h]||[]).forEach(function(e){s.push(e)});if(s.length&&r.removeMesh(s,!1),o&&a)for(var u in t)if(!n[u])if(i[u]){var l=i[u];r.addMesh(l)}else{var c=this._getXYZOfIndex(u),f=c.x,v=c.y,d=c.z;this.getTileUrl(f,v,d)}this._loadTiles=Object.assign({},t),this._diffCache()}},t._init=function(){},t._workerLoad=function(e){var t=e.target._img;t.currentCount++,t.currentCount===t.needCount&&(t.src=jt(t._key,this._opts.debug))},t._generateBaseObjects=function(e,t,n){var r=this;if(t&&n){if(!this._getCurentTileKeys().keysMap[e])return void(n.src=jt(e,this._opts.debug));var i=this.formatBaseObjects(e,t);if(i.length){n.needCount=i.length;for(var o=n.currentCount=0,a=i.length;o<a;o++){var s=i[o];s._img=n,(s._vt=this).isVisible()||s.hide(),this._cachetile(e,s),s.isAsynchronous()||n.currentCount++}this._layer.addMesh(i,!1),n.needCount===n.currentCount&&(n.src=jt(e,this._opts.debug)),this.isAsynchronous()?i.filter(function(e){return e.isAsynchronous()}).forEach(function(e){e.on("workerload",r._workerLoad,r)}):n.src=jt(e,this._opts.debug)}else n.src=jt(e,this._opts.debug);this._loadTiles[e]=!0}else n&&(n.src=jt(e,this._opts.debug))},t._diffCache=function(){var i=this;Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max&&function(){var e=i._renderer.tileCache.data,t=i._renderer.tilesInView,n=[];for(var r in i._baseObjectKeys)e[r]||t[r]||((i._baseObjectKeys[r]||[]).forEach(function(e){e.isAdd&&n.push(e)}),i._diposeBaseObject(r),delete i._baseObjectKeys[r]);n.length&&i._layer.removeMesh(n,!1)}()},t._diposeBaseObject=function(e){var t=this._baseObjectKeys[e];t&&t.length&&t.forEach(function(e){e.getObject3d().geometry.dispose(),e._geometryCache&&e._geometryCache.dispose();var t=e._baseObjects;t&&t.length&&t.forEach(function(e){e.getObject3d().geometry.dispose(),e=null}),e._datas=null,e._geometriesAttributes=null,e._faceMap=null,e=null})},t._cachetile=function(e,t){this._baseObjectKeys[e]||(this._baseObjectKeys[e]=[]),this._baseObjectKeys[e].push(t)},t._getXYZOfIndex=function(e){var t=-1<e.indexOf("_")?"_":"-",n=e.split(t).slice(1,4),r=n[0],i=n[1],o=n[2];return{x:i=parseInt(i),y:r=parseInt(r),z:o=parseInt(o)}},t._getTileExtent=function(e,t,n){var r=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(e,t,r)},t._getTileLngLatExtent=function(e,t,n){var r=this._getTileExtent(e,t,n),i=r.getMax(),o=r.getMin(),a=this.getMap().getProjection();return o=a.unproject(o),i=a.unproject(i),new ue.Extent(o,i)},e}(ue.TileLayer),At={worker:!1},St=function(o){function e(e,t,n,r){var i;return void 0===t&&(t={}),(i=o.call(this,ue.Util.GUID(),ue.Util.extend({urlTemplate:e},At,t))||this)._opts=t,i._layer=r,i.getMaterial=n,i._baseObjectKeys={},i._loadTiles={},i._add=null,i._layerLaodTime=(new Date).getTime(),i._init(),i}i(e,o);var t=e.prototype;return t.formatBaseObjects=function(e,t){var n=this._opts,r=[],i=this.isAsynchronous();for(var o in t){var a=t[o]||{},s=void 0;if(Array.isArray(a)?s=a:"FeatureCollection"===a.type&&(s=a.features),s&&s.length){for(var h=[],u=[],l=[],c=0,f=s.length;c<f;c++){var v=s[c];if(_e(v))h.push(v);else if(we(v))for(var d=Te(v),g=0,p=d.length;g<p;g++)u.push(d[g]);else if(Me(v))for(var x=Te(v),y=0,m=x.length;y<m;y++)l.push(ue.Util.extend({},x[y].properties,x[y],{coordinate:Oe(x[y])}))}if(h.length){var b=this._getMaterial(o,h,e,a);if(b){var _=this._layer.toExtrudePolygons(h,ue.Util.extend({},{topColor:"#fff",layerName:o,asynchronous:i,key:e},n),b);r.push(_)}}if(u.length){var w=this._getMaterial(o,u,e,a);if(w&&(w instanceof le.LineBasicMaterial||w instanceof le.LineDashedMaterial)){var M=this._layer.toLines(u,ue.Util.extend({},{layerName:o},n),w);r.push(M)}}if(l.length){var O=this._getMaterial(o,l,e,a);if(O&&O instanceof le.PointsMaterial){var j=this._layer.toPoints(l,ue.Util.extend({},{layerName:o},n),O);r.push(j)}}}}return r},t.loopMessage=function(e){0<{waitingQueue:_t,currentQueue:wt}.currentQueue.length&&this.getTileData(e)},t._init=function(){var o=this;this.on("layerload",this._layerOnLoad),this.on("add",function(){if(!1===o._add){var e=o.getBaseObjects();o._layer.addMesh(e)}o._add=!0,o.intervalId=setInterval(function(){o._isLoad()&&!o._layer.getMap().isInteracting()&&o.fire("layerload")},1e3)}),this.on("remove",function(){o._add=!1;var e=o.getBaseObjects();o._layer.removeMesh(e),clearInterval(o.intervalId)}),this.on("show",function(){var e=o.getBaseObjects();for(var t in e.forEach(function(e){e.show()}),o._baseObjectKeys){(o._baseObjectKeys[t]||[]).forEach(function(e){e.show()})}}),this.on("hide",function(){var e=o.getBaseObjects();for(var t in e.forEach(function(e){e.hide()}),o._baseObjectKeys){(o._baseObjectKeys[t]||[]).forEach(function(e){e.hide()})}}),this.on("renderercreate",function(e){e.renderer.loadTile=function(e){var t=this.layer.getTileSize(),n=new Image;return n.width=t.width,n.height=t.height,n.onload=this.onTileLoad.bind(this,n,e),n.onerror=this.onTileError.bind(this,n,e),this.loadTileImage(n,e.url,e.dupKey),n},e.renderer.deleteTile=function(e){if(e&&e.image){e.image.onload=null,e.image.onerror=null;var t,n,r=e.info||{};(n=Mt(_t,t=r.dupKey))&&n(t)}},e.renderer.loadTileImage=function(e,t,n){var r,i;e._key=n,i={key:n,url:t,callback:function(e,t,n){o._generateBaseObjects(e,t,n),function(e,t){if(Mt(wt,e),_t.length){wt.push(_t[0]),_t.splice(0,1);var n=wt[wt.length-1];t.loopMessage(n)}}(e,o)},img:e,vt:r=o},wt.length<10?(wt.push(i),r.loopMessage(i)):_t.push(i)}})},t._getMaterial=function(e,t,n,r){return this.getMaterial&&ue.Util.isFunction(this.getMaterial)?this.getMaterial(e,t,n,r):null},e}(Ct),Bt=new le.TextureLoader,It=document.createElement("canvas"),Vt=256;function zt(e){return e?("string"==typeof e?(t=new Image).src=e:e instanceof HTMLCanvasElement?(t=new Image).src=e.toDataURL():e instanceof Image&&((t=new Image).src=e.src,t.crossOrigin=e.crossOrigin),t&&!t.crossOrigin&&(t.crossOrigin="Anonymous"),t):null;var t}var kt={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null},Lt=function(j){function e(e,t,a,s){t=ue.Util.extend({},kt,t,{layer:s,extent:e});var n,r=t.texture,i=t.image,o=t.altitude,h=t.imageHeight,u=t.imageWidth;i||console.error("not find image"),e instanceof ue.Extent||(e=new ue.Extent(e));var l=e.xmin,c=e.ymin,f=e.xmax,v=e.ymax,d=1/0,g=1/0,p=-1/0,x=-1/0;[[l,c],[l,v],[f,v],[f,c]].forEach(function(e){var t=s.coordinateToVector3(e),n=t.x,r=t.y;d=Math.min(n,d),g=Math.min(r,g),p=Math.max(n,p),x=Math.max(r,x)});var y=Math.abs(p-d),m=Math.abs(x-g),b=zt(i),_=zt(r),w=new le.PlaneBufferGeometry(y,m,u-1,h-1);(n=j.call(this)||this)._initOptions(t),n._createMesh(w,a);var M=s.distanceToVector3(o,o).x,O=s.coordinateToVector3(e.getCenter(),M);return n.getObject3d().position.copy(O),a.transparent=!0,b&&(a.opacity=0,b.onload=function(){for(var e=function(e,t,n){void 0===t&&(t=Vt),void 0===n&&(n=Vt),It.width=t,It.height=n;var r=It.getContext("2d");return r.drawImage(e,0,0,t,n),r.getImageData(0,0,t,n).data}(b,u,h),t=0,n=0,r=e.length;n<r;n+=4){var i=.1*(256*e[n]*256+256*e[n+1]+e[n+2])-1e4,o=s.distanceToVector3(i,i).x;w.attributes.position.array[3*t+2]=o,t++}w.attributes.position.needsUpdate=!0,_?Bt.load(_.src,function(e){a.map=e,a.opacity=1,a.needsUpdate=!0}):a.opacity=1},b.onerror=function(){console.error("not load "+b.src)}),n}return i(e,j),e}(l),Pt={scale:1},Et=function(o){function e(e,t,n,r){var i;return void 0===t&&(t={}),(i=o.call(this,ue.Util.GUID(),ue.Util.extend({urlTemplate:e},Pt,t))||this)._opts=t,i._layer=r,i.material=n,i._baseObjectKeys={},i._loadTiles={},i._add=null,i._imgQueue={},i._layerLaodTime=(new Date).getTime(),i._init(),i}i(e,o);var t=e.prototype;return t.isAsynchronous=function(){return!1},t.formatBaseObjects=function(e,t){var n=[],r=this.options.scale,i=this._getXYZOfIndex(e),o=i.x,a=i.y,s=i.z,h=this.getMap().getZoom(),u=this.getTileUrl(o,a,s),l=this.options.tileSize,c=l[0],f=l[1],v=this._getTileLngLatExtent(o,a,s),d=this.material.clone();if(s+1>=Math.round(h)){var g=new Lt(v,{image:t,imageWidth:c/8,imageHeight:f/8,texture:u},d,this._layer);g.getObject3d().scale.set(r,r,1),n.push(g)}return n},t.loopMessage=function(e){this.getTileData(e)},t._init=function(){var o=this;this.on("layerload",this._layerOnLoad),this.on("add",function(){if(!1===o._add){var e=o.getBaseObjects();o._layer.addMesh(e)}o._add=!0,o.intervalId=setInterval(function(){o._isLoad()&&!o._layer.getMap().isInteracting()&&o.fire("layerload")},1e3)}),this.on("remove",function(){o._add=!1;var e=o.getBaseObjects();o._layer.removeMesh(e),clearInterval(o.intervalId)}),this.on("show",function(){var e=o.getBaseObjects();for(var t in e.forEach(function(e){e.show()}),o._baseObjectKeys){(o._baseObjectKeys[t]||[]).forEach(function(e){e.show()})}}),this.on("hide",function(){var e=o.getBaseObjects();for(var t in e.forEach(function(e){e.hide()}),o._baseObjectKeys){(o._baseObjectKeys[t]||[]).forEach(function(e){e.hide()})}}),this.on("renderercreate",function(e){e.renderer.loadTile=function(e){var t=this.layer.getTileSize(),n=new Image;return n.width=t.width,n.height=t.height,n.onload=this.onTileLoad.bind(this,n,e),n.onerror=this.onTileError.bind(this,n,e),this.loadTileImage(n,e.url,e.dupKey),n},e.renderer.deleteTile=function(e){if(e&&e.image){e.image.onload=null,e.image.onerror=null;var t=e.info||{},n=o._imgQueue[t.dupKey];n&&(n.src="",n.onload=null,n.onerror=null,delete o._imgQueue[t.dupKey])}},e.renderer.loadTileImage=function(e,t,n){e._key=n;var r=new Image,i={key:n,url:t,rgbImage:o._imgQueue[n]=r,callback:function(e,t,n){o._generateBaseObjects(e,t,n)},img:e,vt:o};o.loopMessage(i)}})},e}(Ct);function Ut(e){e=e||{},this.gradient=e.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=e.maxSize||35,this.minSize=e.minSize||0,this.max=e.max||100,this.min=e.min||0,this.initPalette()}function Zt(e,t,n){var r=Rt(n),i=n.min||0,o=r-i,a=n.range||null,s=0,h=1024;a&&2===a.length&&(s=(a[0]-i)/o*1024),a&&2===a.length&&(h=(a[1]-i)/o*1024);for(var u,l=n.maxOpacity||.8,c=n.minOpacity||0,f=3,v=e.length;f<v;f+=4)u=4*e[f],e[f]/256>l&&(e[f]=256*l),e[f]/256<c&&(e[f]=256*c),u&&s<=u&&u<=h?(e[f-3]=t[u],e[f-2]=t[1+u],e[f-1]=t[2+u]):e[f]=0}function Rt(e){return e.max||100}function Ft(r,e,t){var n,i,o,a,s,h=Rt(t),u=t._size||t.size||13,l=(a=new Tt(2*(o=(n=u)+(i=n/2)),2*o),(s=a.getContext("2d")).shadowBlur=i,s.shadowColor="black",s.shadowOffsetX=s.shadowOffsetY=1e4,s.beginPath(),s.arc(o-1e4,o-1e4,n,0,2*Math.PI,!0),s.closePath(),s.fill(),a),c=l.width/2,f=l.height/2,v=e,d={};for(var g in v.forEach(function(e){var t=void 0===e.count?1:e.count,n=Math.min(1,t/h).toFixed(2);d[n]=d[n]||[],d[n].push(e)}),d)if(!isNaN(g)){var p=d[g];r.beginPath(),t.withoutAlpha||(r.globalAlpha=g),p.forEach(function(e){var t=e.coordinate,n=void 0===e.count?1:e.count;r.globalAlpha=n/h,r.drawImage(l,t[0]-c,t[1]-f)})}}Ut.prototype.setMax=function(e){this.max=e||100},Ut.prototype.setMin=function(e){this.min=e||0},Ut.prototype.setMaxSize=function(e){this.maxSize=e||35},Ut.prototype.setMinSize=function(e){this.minSize=e||0},Ut.prototype.initPalette=function(){var e=this.gradient,t=new Tt(256,1),n=this.paletteCtx=t.getContext("2d"),r=n.createLinearGradient(0,0,256,1);for(var i in e)r.addColorStop(parseFloat(i),e[i]);n.fillStyle=r,n.fillRect(0,0,256,1)},Ut.prototype.getColor=function(e){var t=this.getImageData(e);return"rgba("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]/256+")"},Ut.prototype.getImageData=function(e){var t=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===e)return t;var n=this.max,r=this.min;n<e&&(e=n),e<r&&(e=r);var i=4*Math.floor((e-r)/(n-r)*255);return[t[i],t[1+i],t[2+i],t[3+i]]},Ut.prototype.getSize=function(e){var t=this.max,n=this.min,r=this.maxSize,i=this.minSize;return t<e&&(e=t),e<n&&(e=n),n<t?i+(e-n)/(t-n)*(r-i):r};var Gt={draw:function(e,t,n){if(!(e.canvas.width<=0||e.canvas.height<=0)){var r=n.strength||.3;e.strokeStyle="rgba(0,0,0,"+r+")";var i=new Tt(e.canvas.width,e.canvas.height),o=i.getContext("2d");o.scale(devicePixelRatio,devicePixelRatio),n=n||{},e.save();var a=new Ut({gradient:n.gradient});if(Ft(o,t,n),!n.absolute){var s=o.getImageData(0,0,e.canvas.width,e.canvas.height);Zt(s.data,a.getImageData(),n),e.putImageData(s,0,0),e.restore()}i=a=null}},drawGray:Ft,colorize:Zt},Dt={interactive:!(Ut.prototype.getLegend=function(e){var t=this.gradient,n=e.width||20,r=e.height||180,i=new Tt(n,r),o=i.getContext("2d"),a=o.createLinearGradient(0,r,0,0);for(var s in t)a.addColorStop(parseFloat(s),t[s]);return o.fillStyle=a,o.fillRect(0,0,n,r),i}),min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},Wt=function(he){function e(e,t,n,r){var i;Array.isArray(e)||(e=[e]);for(var o=1/0,a=1/0,s=-1/0,h=-1/0,u=[],l=0,c=e.length;l<c;l++){var f=e[l],v=f.coordinate,d=f.lnglat,g=f.xy,p=v||d||g;if(p){var x=r.coordinateToVector3(p);u.push(x);var y=x.x,m=x.y;o=Math.min(o,y),a=Math.min(a,m),s=Math.max(s,y),h=Math.max(h,m)}else console.warn("not find coordinate")}t=ue.Util.extend({},Dt,t,{layer:r,points:e});var b=t.gridScale,_=t.altitude,w=Math.abs(s-o),M=Math.abs(h-a),O=Math.max(w*b,M*b);2048<O&&(console.warn("gridScale: "+b+" it's too big. I hope it's a smaller value,canvas max size is 2048* 2048"),b=2048/(O/b));for(var j=Math.ceil(w*b),T=Math.ceil(M*b),C=j/w,A=T/M,S=[],B=0,I=u.length;B<I;B++){var V=u[B];V.x-=o,V.y-=a,V.x*=C,V.y*=A,V.y=T-V.y,S.push({coordinate:[V.x,V.y],count:e[B].count})}var z=new Tt(j,T).getContext("2d");z.scale(devicePixelRatio,devicePixelRatio),Gt.drawGray(z,S,t);for(var k=z.getImageData(0,0,z.canvas.width,z.canvas.height),L=-1/0,P={},E=[],U=3,Z=k.data.length,R=0;U<Z;U+=4){var F=k.data[U];L=Math.max(L,F),E.push(F),F<=0&&(P[R]=1),R++}var G=new Ut({gradient:t.gradient});Gt.colorize(k.data,G.getImageData(),t);for(var D=new le.PlaneBufferGeometry(w,M,j-1,T-1),W=D.getIndex().array,K=D.attributes.position.array,q=[],H=[],N=new le.Color,Q=0,X=K.length,Y=0,J=W.length,$=0,ee=k.data.length,te=0;Q<Math.max(X,J,ee);Q+=3){if(Q<X){var ne=E[te];0<ne&&(K[Q+2]=ne/L)}if(Y<J){var re=W[Y],ie=W[Y+1],oe=W[Y+2];P[re]&&P[ie]&&P[oe]||q.push(re,ie,oe)}if($<ee){var ae="rgb("+k.data[$]+","+k.data[$+1]+","+k.data[$+2]+")";N.setStyle(ae),H.push(N.r,N.g,N.b)}Y+=3,$+=4,te++}D.setIndex(new le.Uint32BufferAttribute(q,1)),ce(D,"color",new le.Float32BufferAttribute(H,3,!0)),n.vertexColors=le.VertexColors,(i=he.call(this)||this)._initOptions(t),i._createMesh(D,n);var se=r.distanceToVector3(_,_).x;return i.getObject3d().position.copy(new le.Vector3((o+s)/2,(a+h)/2,se)),i}return i(e,he),e}(l),Kt=Math.PI/180,qt=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02]],Ht=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],Nt=new le.Matrix4,Qt=function(e){function t(){return e.apply(this,arguments)||this}i(t,e);var n=t.prototype;return n.draw=function(){this.renderScene()},n.drawOnInteracting=function(){this.renderScene()},n.coordinateToVector3=function(e,t){void 0===t&&(t=0);var n=this.getMap();if(!n)return null;e instanceof ue.Coordinate||(e=new ue.Coordinate(e));var r=n.coordinateToPoint(e,Yt(n));return new le.Vector3(r.x,r.y,t)},n.distanceToVector3=function(e,t,n){var r=this.getMap(),i=Yt(r),o=n||r.getCenter();o instanceof ue.Coordinate||(o=new ue.Coordinate(o));var a=r.locate(o,e,t),s=r.coordinateToPoint(o,i),h=r.coordinateToPoint(a,i),u=Math.abs(h.x-s.x)*ue.Util.sign(e),l=Math.abs(h.y-s.y)*ue.Util.sign(t);return new le.Vector3(u,l,0)},n.toShape=function(e){var n=this;if(!e)return null;if(e instanceof ue.MultiPolygon)return e.getGeometries().map(function(e){return n.toShape(e)});var t=e.getCenter(),r=this.coordinateToVector3(t),i=e.getShell().map(function(e){return n.coordinateToVector3(e).sub(r)}),o=new le.Shape(i),a=e.getHoles();return a&&0<a.length&&(o.holes=a.map(function(e){var t=e.map(function(e){return n.coordinateToVector3(e).sub(r)});return new le.Shape(t)})),o},n.toExtrudeMesh=function(e,t,n,r){var i=this;if(!e)return null;if(e instanceof ue.MultiPolygon)return e.getGeometries().map(function(e){return i.toExtrudeMesh(e,t,n,r)});var o=e.getCoordinates();o.forEach(function(e){for(var t=e.length-1;1<=t;t--)e[t].equals(e[t-1])&&e.splice(t,1)}),e.setCoordinates(o);var a=this.toShape(e),s=this.coordinateToVector3(e.getCenter());r=ue.Util.isNumber(r)?r:t,r=this.distanceToVector3(r,r).x;var h=this.distanceToVector3(t,t).x,u={bevelEnabled:!1,bevelSize:1};u[93<=parseInt(le.REVISION)?"depth":"amount"]=r;var l=new le.ExtrudeGeometry(a,u),c=new le.BufferGeometry;c.fromGeometry(l);var f=new le.Mesh(c,n);return f.position.set(s.x,s.y,h-r),f},n.toExtrudePolygon=function(e,t,n){return new Fe(e,t,n,this)},n.toBar=function(e,t,n){return new G(e,t,n,this)},n.toLine=function(e,t,n){return new Ve(e,t,n,this)},n.toExtrudeLine=function(e,t,n){return new ke(e,t,n,this)},n.toModel=function(e,t){return new De(e,t,this)},n.toExtrudeLineTrail=function(e,t,n){return new tt(e,t,n,this)},n.toExtrudePolygons=function(e,t,n){return new ot(e,t,n,this)},n.toPoint=function(e,t,n){return new ut(e,t,n,this)},n.toPoints=function(e,t,n){return new dt(e,t,n,this)},n.toBars=function(e,t,n){return new pt(e,t,n,this)},n.toExtrudeLines=function(e,t,n){return new yt(e,t,n,this)},n.toLines=function(e,t,n){return new bt(e,t,n,this)},n.toThreeVectorTileLayer=function(e,t,n){return new St(e,t,n,this)},n.toTerrain=function(e,t,n){return new Lt(e,t,n,this)},n.toTerrainVectorTileLayer=function(e,t,n){return new Et(e,t,n,this)},n.toHeatMap=function(e,t,n){return new Wt(e,t,n,this)},n.clearMesh=function(){var e=this.getScene();if(!e)return this;for(var t=e.children.length-1;0<=t;t--)e.children[t]instanceof le.Mesh&&e.remove(e.children[t]);return this},n.lookAt=function(e){var t=this._getRenderer();return t&&t.context.lookAt(e),this},n.getCamera=function(){var e=this._getRenderer();return e?e.camera:null},n.getScene=function(){var e=this._getRenderer();return e?e.scene:null},n.renderScene=function(){var e=this._getRenderer();return e?e.renderScene():this},n.getThreeRenderer=function(){var e=this._getRenderer();return e?e.context:null},n.addMesh=function(e,t){var n=this;if(void 0===t&&(t=!0),!e)return this;Array.isArray(e)||(e=[e]);var r=this.getScene();return e.forEach(function(e){e instanceof l?(r.add(e.getObject3d()),e.isAdd||(e.isAdd=!0,e._fire("add",{target:e})),e._animation&&ue.Util.isFunction(e._animation)&&(n._animationBaseObjectMap[e.getObject3d().uuid]=e)):e instanceof le.Object3D&&r.add(e)}),this._zoomend(),t&&this.renderScene(),this},n.removeMesh=function(e,t){var n=this;if(void 0===t&&(t=!0),!e)return this;Array.isArray(e)||(e=[e]);var r=this.getScene();return e.forEach(function(e){e instanceof l?(r.remove(e.getObject3d()),e.isAdd&&(e.isAdd=!1,e._fire("remove",{target:e})),e._animation&&ue.Util.isFunction(e._animation)&&delete n._animationBaseObjectMap[e.getObject3d().uuid]):e instanceof le.Object3D&&r.remove(e)}),t&&this.renderScene(),this},n._initRaycaster=function(){return this._raycaster||(this._raycaster=new le.Raycaster,this._mouse=new le.Vector2),this},n.identify=function(t,e){var r=this;if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new ue.Coordinate(t)),!(t instanceof ue.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];var n=this.getMap().coordToContainerPoint(t),i=n.x,o=n.y;this._initRaycaster();var a=this._raycaster,s=this._mouse,h=this.getCamera(),u=this.getScene(),l=this.getMap().getSize();if(!u)return[];var c=l.width,f=l.height;s.x=i/c*2-1,s.y=-o/f*2+1,a.setFromCamera(s,h),a.params.Line.threshold=this._getLinePrecision(this.getMap().getResolution());var v=[],d=[];u.children.forEach(function(e){var t=e.__parent;t&&t.getOptions?t.getOptions().interactive&&t.isVisible()&&(t.identify&&ue.Util.isFunction(t.identify)?d.push(t):v.push(e)):(e instanceof le.Mesh||e instanceof le.Group)&&v.push(e)});var g=[],p=a.intersectObjects(v,!0);p&&Array.isArray(p)&&p.length&&(g=p.map(function(e){var t=e.object,n=(t=r._recursionMesh(t)).__parent||t;return n.faceIndex=e.faceIndex,n.index=e.index,n})),d.length&&d.forEach(function(e){e.identify(t)&&g.push(e)});var x=(e=ue.Util.extend({},e)).count;return ue.Util.isNumber(x)&&0<x?g.slice(0,x):g},n._recursionMesh=function(e){for(;e&&!(e.parent instanceof le.Scene);)e=e.parent;return e||{}},n._getLinePrecision=function(e){void 0===e&&(e=10);for(var t=0,n=qt.length;t<n;t++){var r=qt[t],i=r[0],o=r[1];if(i<e)return o}return.01},n._identifyBaseObjectEvents=function(n){var e=this.map||this.getMap();e.resetCursor("default");var r=n.type,i=n.coordinate,o=this.identify(i),t=this.getScene();if(0===o.length&&t)for(var a=0,s=t.children.length;a<s;a++){var h=(t.children[a]||{}).__parent;h&&h.fire("empty",Object.assign({},n,{target:h}))}if("mousemove"===r){o.length&&e.setCursor("pointer");var u=[];this._baseObjects&&this._baseObjects.forEach(function(t){var n=!0;o.forEach(function(e){t===e&&(n=!1)}),n&&u.push(t)}),u.forEach(function(e){e instanceof l&&(e.getSelectMesh?e.isHide||(e._mouseover=!1,e.fire("mouseout",Object.assign({},n,{target:e,type:"mouseout",selectMesh:null})),e.closeToolTip()):(e._mouseover=!1,e.fire("mouseout",Object.assign({},n,{target:e,type:"mouseout"})),e.closeToolTip()))}),o.forEach(function(e){if(e instanceof l){e._mouseover||(e.fire("mouseover",Object.assign({},n,{target:e,type:"mouseover",selectMesh:e.getSelectMesh?e.getSelectMesh():null})),e._mouseover=!0),e.fire(r,Object.assign({},n,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}));var t=e.getToolTip();t&&!t._owner&&t.addTo(e),e.openToolTip(i)}})}else o.forEach(function(e){if(e instanceof l&&(e.fire(r,Object.assign({},n,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null})),"click"===r)){var t=e.getInfoWindow();t&&!t._owner&&t.addTo(e),e.openInfoWindow(i)}});return this._baseObjects=o,this},n._zoomend=function(){var e=this.getScene();if(e){var i=this.getMap().getZoom();e.children.forEach(function(e){var t=e.__parent;if(t&&t.getOptions){var n=t.getMinZoom(),r=t.getMaxZoom();(i<n||r<i)&&t.isVisible()?t.hide():n<=i&&i<=r&&!t.isVisible()&&t.show()}})}},n.onAdd=function(){var t=this;e.prototype.onAdd.call(this);var n=this.map||this.getMap();return n&&(Ht.forEach(function(e){n.on(e,t._identifyBaseObjectEvents,t)}),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),n.on("zooming zoomend",this._zoomend,this)),this},n.onRemove=function(){var t=this;e.prototype.onRemove.call(this);var n=this.map||this.getMap();return n&&(Ht.forEach(function(e){n.off(e,t._identifyBaseObjectEvents,t)}),n.off("zooming zoomend",this._zoomend,this)),this},n._callbackBaseObjectAnimation=function(){if(this._animationBaseObjectMap)for(var e in this._animationBaseObjectMap){this._animationBaseObjectMap[e]._animation()}return this},n._getFovRatio=function(){var e=this.getMap().getFov();return Math.tan(e/2*Kt)},t}(ue.CanvasLayer);Qt.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null});var Xt=function(e){function t(){return e.apply(this,arguments)||this}i(t,e);var n=t.prototype;return n.getPrepareParams=function(){return[this.scene,this.camera]},n.getDrawParams=function(){return[this.scene,this.camera]},n._drawLayer=function(){e.prototype._drawLayer.apply(this,arguments)},n.hitDetect=function(){return!1},n.createCanvas=function(){e.prototype.createCanvas.call(this),this.createContext()},n.createContext=function(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{var e=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0};e.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,e)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)},n._initThreeRenderer=function(){var e=new le.WebGLRenderer({context:this.gl,alpha:!0});e.autoClear=!1,e.setClearColor(new le.Color(1,1,1),0),e.setSize(this.canvas.width,this.canvas.height),e.clear(),e.canvas=this.canvas,this.context=e;var t=this.scene=new le.Scene,n=this.layer.getMap(),r=n.getFov()*Math.PI/180,i=this.camera=new le.PerspectiveCamera(r,n.width/n.height,n.cameraNear,n.cameraFar);i.matrixAutoUpdate=!1,this._syncCamera(),t.add(i)},n.onCanvasCreate=function(){e.prototype.onCanvasCreate.call(this)},n.resizeCanvas=function(e){if(this.canvas){var t;t=e||this.getMap().getSize();var n=ue.Browser.retina?2:1,r=this.canvas;r.height=n*t.height,r.width=n*t.width,this.context.setSize(r.width,r.height)}},n.clearCanvas=function(){this.canvas&&this.context.clear()},n.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},n.renderScene=function(){this.layer._callbackBaseObjectAnimation(),this._syncCamera(),this.context.render(this.scene,this.camera),this.completeRender()},n.remove=function(){delete this._drawContext,e.prototype.remove.call(this)},n._syncCamera=function(){var e=this.getMap(),t=this.camera;t.matrix.elements=e.cameraWorldMatrix,t.projectionMatrix.elements=e.projMatrix,t.projectionMatrixInverse.elements=Nt.getInverse(t.projectionMatrix).elements},n._createGLContext=function(e,t){for(var n=["webgl","experimental-webgl"],r=null,i=0;i<n.length;++i){try{r=e.getContext(n[i],t)}catch(e){}if(r)break}return r},t}(ue.renderer.CanvasLayerRenderer);function Yt(e){return e.getGLZoom()}Qt.registerRenderer("gl",Xt),e.ThreeLayer=Qt,e.ThreeRenderer=Xt,e.BaseObject=l,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.10.1, requires maptalks@>=0.39.0.")});
